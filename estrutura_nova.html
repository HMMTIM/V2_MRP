<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NALITECK - Cadastro de Estrutura e Processo (Explorer)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
  --primary-color: #0854a0;
  --primary-hover: #0a4d8c;
  --secondary-color: #f0f3f6;
  --border-color: #d4d4d4;
  --text-color: #333;
  --text-secondary: #666;
  --success-color: #107e3e;
  --success-hover: #0d6e36;
  --danger-color: #bb0000;
  --danger-hover: #a30000;
  --warning-color: #e9730c;
  --header-bg: #354a5f;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f7f7f7;
  color: var(--text-color);
}

.sap-header {
  background-color: var(--header-bg);
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 100;
}

.sap-logo {
  font-size: 24px;
  font-weight: 500;
}

.container {
  display: flex;
  width: 100%;
  height: calc(100vh - 60px);
  margin-top: 60px;
}

.search-panel {
  width: 30%;
  padding: 20px;
  background-color: #ffffff;
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.structure-panel {
  width: 70%;
  padding: 20px;
  background-color: #ffffff;
  overflow-y: auto;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.sap-title {
  font-size: 18px;
  font-weight: 500;
  margin-bottom: 20px;
  color: var(--primary-color);
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.search-box {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 20px;
}

.search-box input,
.search-box select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 14px;
}

.search-box input:focus,
.search-box select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(8, 84, 160, 0.1);
}

.search-box button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.2s;
}

.btn-primary {
  background-color: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-hover);
}

.btn-success {
  background-color: var(--success-color);
  color: white;
}

.btn-success:hover {
  background-color: var(--success-hover);
}

.btn-success:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.btn-danger {
  background-color: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background-color: var(--danger-hover);
}

.product-list {
  max-height: 70vh;
  overflow-y: auto;
}

.product-item {
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  margin-bottom: 5px;
  background-color: #f8f9fa;
  cursor: move;
}

.product-item.dragging {
  opacity: 0.5;
}

.product-item:hover {
  background-color: #f0f3f6;
}

.folder {
  padding: 20px;
  border: 1px solid var(--border-color);
  margin-bottom: 10px;
  background-color: #fff;
  border-radius: 8px;
}

.folder-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-weight: 400;
}

.folder-dates {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.folder-section {
  margin-top: 10px;
  padding-left: 20px;
  display: none;
}

.folder-section.open {
  display: block;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--text-secondary);
}

.operation {
  padding: 12px 10px;
  border: 1px solid var(--border-color);
  margin-bottom: 5px;
  background-color: #fff;
  display: flex;
  align-items: center;
  gap: 10px;
  border-radius: 4px;
}

.component {
  padding: 8px;
  border: 1px solid var(--border-color);
  margin-bottom: 5px;
  background-color: #fff;
  display: flex;
  align-items: center;
  gap: 10px; /* Espaço entre elementos */
}

.component .sequence-input, .operation .sequence-input {
  width: 50px; /* Mantendo o mesmo tamanho para ambos */
  padding: 5px;
  border: 1px solid var(--border-color);
  border-radius: 3px;
  text-align: center;
}

.component span {
  flex-grow: 1; /* Faz o texto ocupar o espaço restante */
}

.component div {
  display: flex;
  align-items: center;
  gap: 5px;
}

.operation .operacao {
  width: 100px;
  height: 30px;
  font-size: 14px;
  flex-grow: 0.4;
}

.operation .recurso {
  width: 100px;
  height: 30px;
  font-size: 14px;
  flex-grow: 0.4;
}

.operation .tempo {
  width: 30px;
  height: 30px;
  font-size: 14px;
  flex-grow: 0.4;
}

.operation textarea {
  width: 280px;
  height: 30px;
  font-size: 14px;
}

.operation-controls {
  display: flex;
  gap: 5px;
}

.move-btn {
  padding: 5px 10px;
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.move-btn:hover {
  background-color: #5a6268;
}

.sap-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.sap-buttons button {
  height: 38px;  /* Altura fixa para todos os botões */
  padding: 0 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
}

.sap-buttons .btn-group {
  display: flex;
  gap: 10px;
  margin-bottom: 0;  /* Remove margem inferior do grupo de botões */
}

.sap-buttons .btn-primary,
.sap-buttons .btn-success,
.sap-buttons .btn-danger {
  height: 38px;  /* Garante que todos os tipos de botões tenham a mesma altura */
}

.btn-primary {
  background-color: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-hover);
}

.btn-success {
  background-color: var(--success-color);
  color: white;
}

.btn-success:hover {
  background-color: var(--success-hover);
}

.btn-success:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.btn-danger {
  background-color: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background-color: var(--danger-hover);
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
}

.modal-content {
  background-color: #ffffff;
  margin: 5% auto;
  padding: 20px;
  width: 90%;
  max-width: 800px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: relative;
}

.close {
  position: absolute;
  right: 20px;
  top: 15px;
  font-size: 24px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
}

.close:hover {
  color: #333;
}

.search-container {
  margin-bottom: 20px;
}

.search-group {
  position: relative;
}

.search-label {
  display: block;
  margin-bottom: 8px;
  color: var(--text-secondary);
  font-weight: 500;
}

.search-input {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 14px;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.search-result-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
}

.search-result-item:hover {
  background-color: var(--secondary-color);
}

.summary-box {
  background-color: var(--secondary-color);
  padding: 15px;
  border-radius: 4px;
  margin-bottom: 20px;
}

.usage-info {
  margin: 10px 0;
  line-height: 1.6;
}

.summary-info {
  display: flex;
  gap: 20px;
  margin-top: 15px;
}

.summary-item {
  text-align: center;
}

.summary-value {
  font-size: 24px;
  font-weight: bold;
  color: var(--primary-color);
}

.summary-label {
  color: var(--text-secondary);
  font-size: 14px;
}

.table-responsive {
  overflow-x: auto;
}

.usage-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.usage-table th,
.usage-table td {
  padding: 12px;
  text-align: left;
  border: 1px solid var(--border-color);
}

.usage-table th {
  background-color: var(--secondary-color);
  font-weight: 500;
  color: var(--text-secondary);
}

.usage-table tr:hover {
  background-color: var(--secondary-color);
}

.no-results {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
  font-style: italic;
}

.error-message {
  color: var(--danger-color);
  text-align: center;
  padding: 20px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 14px;
}

#historyList table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

#historyList th,
#historyList td {
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  text-align: left;
}

#historyList th {
  background-color: var(--secondary-color);
  font-weight: 600;
  color: var(--text-secondary);
}

#historyList tbody tr {
  cursor: pointer;
}

#historyList tbody tr:hover {
  background-color: #f8f9fa;
}

#historyList tbody tr.selected {
  background-color: var(--primary-color);
  color: white;
}

.component, .operation {
  transition: background-color 0.2s;
}

/* Alternância de cores para componentes */
.components-list .component:nth-child(odd) {
  background-color: #ffffff; /* Branco */
}

.components-list .component:nth-child(even) {
  background-color: #e1eeff; /* Azul mais visível */
}

/* Alternância de cores para operações */
.operations-list .operation:nth-child(odd) {
  background-color: #ffffff; /* Branco */
}

.operations-list .operation:nth-child(even) {
  background-color: #e1eeff; /* Azul mais visível */
}

/* Estilo para item clicado */
.component.clicked, .operation.clicked {
  background-color: #e0e0e0 !important; /* Cinza claro para destacar */
  color: #000000; /* Texto preto para melhor contraste */
}

/* Estilo para itens no modal */
.modal-item {
  padding: 4px;
  border-bottom: 1px solid #d4d4d4;
}

.modal-item:nth-child(odd) {
  background-color: #f8f9fa;
}

.modal-item:nth-child(even) {
  background-color: #ffffff;
}

.modal-item.clicked {
  background-color: #e6f0fa !important;
}
.sap-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

.structure-panel .sap-buttons button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.2s;
  background-color: var(--primary-color);
  color: white;
}

.structure-panel .sap-buttons button:hover {
  background-color: var(--primary-hover);
}

.structure-panel .sap-buttons .btn-success,
.structure-panel .sap-buttons .btn-danger {
  background-color: var(--primary-color);
}

.structure-panel .sap-buttons .btn-success:hover,
.structure-panel .sap-buttons .btn-danger:hover {
  background-color: var(--primary-hover);
}

.structure-panel .sap-buttons .btn-success:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}
.search-box button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.2s;
}

.btn-primary {
  background-color: var(--primary-color); /* #0854a0 */
  color: white;
}

.btn-primary:hover {
  background-color: var(--primary-hover); /* #0a4d8c */
}
.structure-panel .folder .btn-primary {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.2s;
  background-color: var(--primary-color);
  color: white;
  margin-top: 5px; /* Mantém o estilo inline original */
}

.structure-panel .folder .btn-primary:hover {
  background-color: var(--primary-hover);
}

.form-section {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background-color: #fff;
}

.section-header {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 15px;
  color: var(--primary-color);
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

.form-group {
  margin-bottom: 10px;
}

.form-group label.required::after {
  content: "*";
  color: var(--danger-color);
  margin-left: 4px;
}

.info-text {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.cost-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 5px;
}

.cost-badge {
  background-color: #f0f3f6;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 500;
}

.cost-badge-total {
  background-color: var(--primary-color);
  color: white;
}

.cost-badge-unit {
  background-color: var(--success-color);
  color: white;
}

.tree-item {
  margin-bottom: 10px;
  border: 1px solid var(--border-color);
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 4px;
}

.tree-item-child {
  margin-left: 20px;
}

/* Adicionar ao CSS existente */
.btn-group {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.search-results {
  margin-top: 5px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
  background-color: white;
}

.search-result-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
}

.search-result-item:hover {
  background-color: var(--secondary-color);
}

.usage-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.usage-table th,
.usage-table td {
  padding: 12px;
  text-align: left;
  border: 1px solid var(--border-color);
}

.usage-table th {
  background-color: var(--secondary-color);
  font-weight: 500;
  color: var(--text-secondary);
}

.usage-table tr:hover {
  background-color: var(--secondary-color);
}

.summary-box {
  background-color: var(--secondary-color);
  padding: 15px;
  border-radius: 4px;
  margin-bottom: 20px;
}

.usage-info {
  margin: 5px 0;
  color: var(--text-secondary);
}

.no-results {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
  font-style: italic;
}
  </style>
</head>
<body>
  <div class="sap-header">
    <div class="sap-logo">NALITECK ERP</div>
    <div>Usuário: <span id="userStatus">Não logado</span> | Empresa: 1000</div>
  </div>

  <div class="container">
    <div class="search-panel">
      <div class="sap-title">Pesquisar Produtos</div>
      <div class="search-box">
        <select id="parentProductSelect" onchange="loadStructureForProduct()">
          <option value="">Selecione o produto pai...</option>
        </select>
        <input type="text" id="searchInput" placeholder="Digite para pesquisar componentes...">
        <div style="display: flex; gap: 10px;">
          <button class="btn-primary" onclick="searchProducts()">Pesquisar</button>
          <button class="btn-secondary" onclick="updateProductsList()" title="Atualizar lista de produtos">
            <i class="fas fa-sync-alt"></i> Atualizar Lista
          </button>
          <button class="btn-primary" onclick="openProductModal()">Cadastrar Novo Produto</button>
        </div>
      </div>
      <div class="product-list" id="productList"></div>
    </div>

    <div class="structure-panel">
      <div class="sap-title">Estrutura e Processo de Produtos</div>
      <div id="structureTree"></div>
      <div class="sap-buttons">
        <div class="btn-group">
          <button class="btn-primary" onclick="openHistoryModal()">Histórico de Estruturas</button>
          <button class="btn-primary" onclick="openUsageModal()">Onde é Usado</button>
          <button class="btn-primary" onclick="openRevisionHistoryModal()">Histórico de Revisões</button>
        </div>
        <button class="btn-success" onclick="saveStructure()" disabled>Salvar Alterações</button>
        <button class="btn-primary" onclick="window.location.href='index.html'">Voltar</button>
        <button class="btn-danger" onclick="deleteCurrentStructure()">Excluir Estrutura</button>
      </div>
    </div>

    <!-- Modal de Histórico de Estruturas -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeHistoryModal()">×</span>
        <div class="sap-title">Histórico de Estruturas</div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: var(--primary-color); color: white;">
                <th style="padding: 8px; text-align: left;">Código</th>
                <th style="padding: 8px; text-align: left;">Descrição</th>
                <th style="padding: 8px; text-align: left;">Data Criação</th>
                <th style="padding: 8px; text-align: left;">Última Alteração</th>
              </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
          </table>
        </div>
        <div class="sap-buttons" style="margin-top: 10px;">
          <button class="btn-success" onclick="loadSelectedStructure()">Carregar Selecionada</button>
          <button class="btn-danger" onclick="closeHistoryModal()">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Cadastro de Produto -->
  <!-- Modal de Cadastro de Produto -->

<div id="productModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <span class="close-button" onclick="closeProductModal()">×</span>
    <div class="sap-title">Cadastrar Novo Produto</div>
    <form id="productForm" onsubmit="handleProductSubmit(event)">
      <div class="form-section">
        <div class="section-header">Dados Básicos</div>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="form-group" style="max-width: 125px;">
            <label class="required">Código</label>
            <input type="text" id="productCode" required>
            <div class="info-text">Código único do material</div>
          </div>
          <div class="form-group" style="max-width: none;">
            <label class="required">Descrição</label>
            <input type="text" id="productDescription" required>
          </div>
          <div class="form-group" style="max-width: 125px;">
            <label class="required">Tipo</label>
            <select id="productType" required>
              <option value="PA">PA - Produto Acabado</option>
              <option value="SP">SP - Sub-Produto</option>
              <option value="MP">MP - Matéria Prima</option>
              <option value="HR">HR - Hora Máquina</option>
              <option value="SV">SV - Serviço</option>
            </select>
          </div>
          <div class="form-group" style="max-width: 125px;">
            <label class="required">Unidade Principal</label>
            <select id="productUnit" required>
              <option value="PC">PC - Peça</option>
              <option value="KG">KG - Quilograma</option>
              <option value="MT">MT - Metro</option>
              <option value="MM">MM - Milímetro</option>
              <option value="MO">MO - Mão de Obra</option>
              <option value="SV">SV - Serviço</option>
              <option value="KT">KT - Kit</option>
              <option value="CJ">CJ - Conjunto</option>
              <option value="PA">PA - Par</option>
            </select>
          </div>
          <div class="form-group">
            <label>Unidade Secundária</label>
            <select id="productUnitSecondary">
              <option value="">Nenhuma</option>
              <option value="KG">KG - Quilograma</option>
              <option value="PC">PC - Peça</option>
              <option value="MT">MT - Metro</option>
              <option value="MM">MM - Milímetro</option>
            </select>
            <div class="info-text">Usada para conversões</div>
          </div>
          <div class="form-group">
            <label>Fator de Conversão</label>
            <input type="number" id="productConversionFactor" min="0.001" step="0.001" placeholder="Ex: 1 PC = X KG">
            <div class="info-text">1 unidade principal = X secundárias</div>
          </div>
          <div class="form-group">
            <label>Filtrar Grupo</label>
            <input type="text" id="groupFilter" placeholder="Digite para filtrar..." oninput="filterGroups()">
          </div>
          <div class="form-group">
            <label>Grupo</label>
            <select id="productGroup"></select>
          </div>
          <div class="form-group">
            <label>Filtrar Família</label>
            <input type="text" id="familyFilter" placeholder="Digite para filtrar..." oninput="filterFamilies()">
          </div>
          <div class="form-group">
            <label>Família</label>
            <select id="productFamily"></select>
          </div>
          <div class="form-group">
            <label>Lead Time (dias)</label>
            <input type="number" id="productLeadTime" min="0" value="0">
          </div>
          <div class="form-group">
            <label>Estoque Mínimo</label>
            <input type="number" id="productMinStock" min="0" step="0.001" value="0">
          </div>
          <div class="form-group">
            <label>Estoque Máximo</label>
            <input type="number" id="productMaxStock" min="0" step="0.001" value="0">
          </div>
          <div class="form-group">
            <label>Ponto de Pedido</label>
            <input type="number" id="productOrderPoint" min="0" step="0.001" value="0">
          </div>
        </div>
      </div>
      <div class="sap-buttons">
        <button type="submit" class="btn-success">Cadastrar</button>
        <button type="button" class="btn-danger" onclick="closeProductModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  import { db } from './firebase-config.js';
  import { 
    collection, 
    addDoc, 
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc,
    getDoc,
    orderBy 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let produtos = [];
  let produtosPaisFiltrados = [];
  let operacoes = [];
  let recursos = [];
  let estruturas = [];
  let grupos = [];
  let familias = [];
  let central = []; // Adicione esta linha
  let usuarioAtual = null;
  let initialStructureState = null;
  let hasChanges = false;


    window.onload = async function() {
      usuarioAtual = JSON.parse(localStorage.getItem('currentUser'));
      if (!usuarioAtual) {
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('userStatus').textContent = usuarioAtual.nome;

      await carregarDados();
      setupDragAndDrop();
      populateParentProductSelect();
      searchProducts();
    };

    async function carregarDados() {
  try {
    const [produtosSnap, operacoesSnap, recursosSnap, estruturasSnap, gruposSnap, familiasSnap, centralSnap] = await Promise.all([
      getDocs(collection(db, "produtos")),
      getDocs(collection(db, "operacoes")),
      getDocs(collection(db, "recursos")),
      getDocs(collection(db, "estruturas")),
      getDocs(collection(db, "grupos")),
      getDocs(collection(db, "familias")),
      getDocs(collection(db, "central"))
    ]);

    produtos = produtosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    produtosPaisFiltrados = produtos.filter(p => p.tipo === 'PA' || p.tipo === 'SP');
    operacoes = operacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    recursos = recursosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    estruturas = estruturasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    grupos = gruposSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    familias = familiasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    central = centralSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    console.log("Produtos carregados:", produtos); // Verifica produtos
    console.log("Central carregada:", central);   // Verifica central

    populateProductModalSelects();
  } catch (error) {
    console.error("Erro ao carregar dados:", error);
    alert("Erro ao carregar dados.");
  }
}

    function populateParentProductSelect() {
    const parentSelect = document.getElementById('parentProductSelect');
    parentSelect.innerHTML = '<option value="">Selecione o produto pai...</option>';

    // Ordena os produtos por código em ordem alfabética
    const sortedProducts = [...produtosPaisFiltrados].sort((a, b) => 
    a.codigo.localeCompare(b.codigo)
    );

   sortedProducts.forEach(produto => {
    parentSelect.innerHTML += `<option value="${produto.id}">${produto.codigo} - ${produto.descricao} (${produto.tipo})</option>`;
   });
    }

    function populateProductModalSelects() {
      const groupSelect = document.getElementById('productGroup');
      const familySelect = document.getElementById('productFamily');

      groupSelect.innerHTML = '<option value="">Selecione um grupo</option>';
      grupos.forEach(grupo => {
        groupSelect.innerHTML += `<option value="${grupo.codigoGrupo}">${grupo.codigoGrupo} - ${grupo.nomeGrupo}</option>`;
      });

      familySelect.innerHTML = '<option value="">Selecione uma família</option>';
      familias.forEach(familia => {
        familySelect.innerHTML += `<option value="${familia.codigoFamilia}">${familia.codigoFamilia} - ${familia.nomeFamilia}</option>`;
      });
    }

// Função para fechar o modal
window.closeProductModal = function() {
  document.getElementById('productModal').style.display = 'none';
};

// Função para abrir o modal (já fornecida, mas incluída para contexto)
window.openProductModal = function() {
  document.getElementById('productModal').style.display = 'block';
  document.getElementById('productForm').reset();
  document.getElementById('productLeadTime').value = '0';
  document.getElementById('productMinStock').value = '0';
  document.getElementById('productMaxStock').value = '0';
  document.getElementById('productOrderPoint').value = '0';
  document.getElementById('groupFilter').value = '';
  document.getElementById('familyFilter').value = '';
  filterGroups();
  filterFamilies();
};

// Função para filtrar grupos
window.filterGroups = function() {
  const filterText = document.getElementById('groupFilter').value.toLowerCase();
  const groupSelect = document.getElementById('productGroup');
  groupSelect.innerHTML = '<option value="">Selecione um grupo</option>';
  grupos
    .filter(g => g.codigoGrupo.toLowerCase().includes(filterText) || g.nomeGrupo.toLowerCase().includes(filterText))
    .sort((a, b) => a.codigoGrupo.localeCompare(b.codigoGrupo))
    .forEach(grupo => {
      groupSelect.innerHTML += `<option value="${grupo.codigoGrupo}">${grupo.codigoGrupo} - ${grupo.nomeGrupo}</option>`;
    });
};

// Função para filtrar famílias
window.filterFamilies = function() {
  const filterText = document.getElementById('familyFilter').value.toLowerCase();
  const familySelect = document.getElementById('productFamily');
  familySelect.innerHTML = '<option value="">Selecione uma família</option>';
  familias
    .filter(f => f.codigoFamilia.toLowerCase().includes(filterText) || f.nomeFamilia.toLowerCase().includes(filterText))
    .sort((a, b) => a.codigoFamilia.localeCompare(b.codigoFamilia))
    .forEach(familia => {
      familySelect.innerHTML += `<option value="${familia.codigoFamilia}">${familia.codigoFamilia} - ${familia.nomeFamilia}</option>`;
    });
};

// Função para submeter o formulário
window.handleProductSubmit = async function(event) {
  event.preventDefault();

  const codigo = document.getElementById('productCode').value.trim();
  const descricao = document.getElementById('productDescription').value.trim();
  const tipo = document.getElementById('productType').value;
  const unidade = document.getElementById('productUnit').value;
  const unidadeSecundaria = document.getElementById('productUnitSecondary').value;
  const fatorConversao = document.getElementById('productConversionFactor').value;
  const grupo = document.getElementById('productGroup').value;
  const familia = document.getElementById('productFamily').value;
  const leadTime = document.getElementById('productLeadTime').value;
  const estoqueMinimo = document.getElementById('productMinStock').value;
  const estoqueMaximo = document.getElementById('productMaxStock').value;
  const pontoPedido = document.getElementById('productOrderPoint').value;

  if (!codigo || !descricao || !tipo || !unidade) {
    alert('Por favor, preencha todos os campos obrigatórios.');
    return;
  }

  if (produtos.some(p => p.codigo === codigo)) {
    alert('Já existe um produto com este código.');
    return;
  }

  try {
    const newProduct = {
      codigo,
      descricao,
      tipo,
      unidade,
      unidadeSecundaria,
      fatorConversao,
      grupo,
      familia,
      leadTime,
      estoqueMinimo,
      estoqueMaximo,
      pontoPedido,
      dataCadastro: new Date().toISOString()
    };

    const docRef = await addDoc(collection(db, "produtos"), newProduct);
    newProduct.id = docRef.id;

    // Atualiza a lista de produtos sem recarregar a página
    await updateProductsList();

    closeProductModal();
    alert("Produto cadastrado com sucesso!");
  } catch (error) {
    console.error("Erro ao cadastrar produto:", error);
    alert("Erro ao cadastrar produto: " + error.message);
  }
};

    window.loadStructureForProduct = async function() {
      const productId = document.getElementById('parentProductSelect').value;
      const structureTree = document.getElementById('structureTree');
      const saveButton = document.querySelector('.btn-success');

      structureTree.innerHTML = '';
      saveButton.disabled = true;
      initialStructureState = null;
      hasChanges = false;

      if (!productId) {
        console.log("Nenhum produto selecionado - limpando a estrutura");
        return;
      }

      try {
        const produtoPai = produtos.find(p => p.id === productId);
        const existingStructure = estruturas.find(e => e.produtoPaiId === productId);

        if (produtoPai) {
          const folder = createFolder(produtoPai, existingStructure);
          if (existingStructure) {
            populateFolderWithStructure(folder, existingStructure);
            initialStructureState = JSON.parse(JSON.stringify({
              componentes: existingStructure.componentes || [],
              operacoes: existingStructure.operacoes || []
            }));
          } else {
            saveButton.disabled = false;
          }
          structureTree.appendChild(folder);
          setupDragAndDrop();
          setupChangeListeners(folder);
          return Promise.resolve({ produtoPai, estrutura: existingStructure });
        } else {
          console.error("Produto pai não encontrado para ID:", productId);
          return Promise.reject(new Error("Produto pai não encontrado"));
        }
      } catch (error) {
        console.error("Erro ao carregar estrutura:", error);
        return Promise.reject(error);
      }
    };

    function setupChangeListeners(folder) {
      const saveButton = document.querySelector('.btn-success');

      function markAsChanged() {
        hasChanges = true;
        saveButton.disabled = false;
      }

      folder.querySelectorAll('.quantidade').forEach(input => {
        input.addEventListener('input', markAsChanged);
      });

      folder.querySelectorAll('.operation input, .operation select, .operation textarea').forEach(element => {
        element.addEventListener('input', markAsChanged);
      });

      const observer = new MutationObserver(() => {
        markAsChanged();
        folder.querySelectorAll('.quantidade').forEach(input => {
          input.removeEventListener('input', markAsChanged);
          input.addEventListener('input', markAsChanged);
        });
        folder.querySelectorAll('.operation input, .operation select, .operation textarea').forEach(element => {
          element.removeEventListener('input', markAsChanged);
          element.addEventListener('input', markAsChanged);
        });
      });
      observer.observe(folder.querySelector('.folder-content'), { childList: true, subtree: true });
    }

    function populateFolderWithStructure(folder, estrutura) {
  const componentsList = folder.querySelector('.components-list');
  const operationsList = folder.querySelector('.operations-list');

  if (estrutura.componentes) {
    estrutura.componentes.forEach((comp, index) => {
      const produto = produtos.find(p => p.id === comp.componentId);
      if (produto) {
        const documento = central.find(doc => doc.produtoId === produto.id);
        const pdfLink = documento ? documento.linkPdf : '';
        console.log(`Produto: ${produto.codigo}, ID: ${produto.id}, pdfLink: ${pdfLink}`); // Depuração

        const component = document.createElement('div');
        component.className = 'component';
        component.dataset.id = produto.id;
        component.innerHTML = `
          <input type="number" class="sequence-input" placeholder="Seq." min="1" step="1" value="${index + 1}" readonly>
          <span>
            <span style="color: var(--primary-color);">${produto.codigo}</span> - ${produto.descricao} (${produto.tipo})
            <button class="btn-primary" style="margin-left: 5px; padding: 4px 8px; font-size: 12px;" onclick="openDrawingModal('${produto.codigo}', '${pdfLink}')">Ver Desenho</button>
            ${produto.tipo === 'SP' ? `<span style="cursor: pointer; margin-left: 5px;" onclick="showStructureModal('${produto.id}')">+</span>` : ''}
          </span>
          <div>
            <input type="number" class="quantidade" placeholder="Quant." min="0.001" step="0.001" value="${comp.quantidade}">
            <span>${produto.unidade}</span>
            <button class="btn-danger" onclick="removeComponent(this)">X</button>
          </div>
        `;
        componentsList.appendChild(component);
        folder.querySelector('.structure-section').classList.add('open');
      }
    });
  }

  if (estrutura.operacoes) {
    const sortedOperacoes = [...operacoes].sort((a, b) => a.numero.localeCompare(b.numero));
    const sortedRecursos = [...recursos].sort((a, b) => a.codigo.localeCompare(b.codigo));

    estrutura.operacoes.forEach(op => {
      const operation = document.createElement('div');
      operation.className = 'operation';
      operation.innerHTML = `
        <input type="number" class="sequence-input" placeholder="Seq." min="1" step="1" value="${op.sequencia}">
        <select class="operacao" required>
          <option value="">Selecione a operação...</option>
          ${sortedOperacoes.map(o => `<option value="${o.id}" ${o.id === op.operacaoId ? 'selected' : ''}>${o.numero} - ${o.operacao}</option>`).join('')}
        </select>
        <select class="recurso" required>
          <option value="">Selecione o recurso...</option>
          ${sortedRecursos.map(r => `<option value="${r.id}" ${r.id === op.recursoId ? 'selected' : ''}>${r.codigo} - ${r.maquina} (${r.setor})</option>`).join('')}
        </select>
        <input type="number" class="tempo" placeholder="Tempo (min)" min="0.1" step="0.1" value="${op.tempo}">
        <textarea class="descricao" placeholder="Descrição" maxlength="50" rows="1">${op.descricao || ''}</textarea>
        <div class="operation-controls">
          <button type="button" class="move-btn" onclick="moveOperation(this, -1)">↑</button>
          <button type="button" class="move-btn" onclick="moveOperation(this, 1)">↓</button>
          <button class="btn-danger" onclick="removeOperation(this)">X</button>
        </div>
      `;
      operationsList.appendChild(operation);
      folder.querySelector('.process-section').classList.add('open');
    });
  }
}

   window.searchProducts = function() {
   const searchTerm = document.getElementById('searchInput').value.toUpperCase();
   const productList = document.getElementById('productList');
   productList.innerHTML = '';

   const filteredProducts = produtos.filter(p => 
    (p.codigo.toUpperCase().includes(searchTerm) || p.descricao.toUpperCase().includes(searchTerm)) &&
    !['PA'].includes(p.tipo)
   ).slice(0, 20);

   filteredProducts.forEach(produto => {
    const item = document.createElement('div');
    item.className = 'product-item';
    item.draggable = true;
    item.dataset.id = produto.id;
    item.innerHTML = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
    productList.appendChild(item);
   });
   };

   function setupDragAndDrop() {
   // Remove listeners antigos
   document.removeEventListener('dragstart', handleDragStart);
   document.removeEventListener('dragend', handleDragEnd);
   document.removeEventListener('dragover', handleDragOver);
   document.removeEventListener('drop', handleDrop);

   function handleDragStart(e) {
    if (e.target.classList.contains('product-item')) {
      e.target.classList.add('dragging');
      e.dataTransfer.setData('text/plain', e.target.dataset.id);
    }
   }

   function handleDragEnd(e) {
    if (e.target.classList.contains('product-item')) {
      e.target.classList.remove('dragging');
    }
   }

   function handleDragOver(e) {
    if (e.target.closest('.folder')) {
      e.preventDefault(); // Só permite drop se estiver sobre um folder
    }
   }

   function handleDrop(e) {
    if (e.target.closest('.folder')) {
      e.preventDefault();
      e.stopPropagation();
      const folder = e.target.closest('.folder');
      const productId = e.dataTransfer.getData('text/plain');
      const produto = produtos.find(p => p.id === productId);
      if (produto) {
        addComponentToFolder(folder, produto);
      }
    }
   }

   // Adiciona listeners ao document
   document.addEventListener('dragstart', handleDragStart);
   document.addEventListener('dragend', handleDragEnd);
   document.addEventListener('dragover', handleDragOver);
   document.addEventListener('drop', handleDrop);
   }
// Adicionar evento de clique para componentes e operações

  document.addEventListener('click', function(e) {
  const component = e.target.closest('.component');
  const operation = e.target.closest('.operation');
  const modalItem = e.target.closest('.modal-item');

  // Remove classe 'clicked' de todos os itens
  document.querySelectorAll('.component.clicked, .operation.clicked, .modal-item.clicked').forEach(item => {
    item.classList.remove('clicked');
  });

  // Adiciona classe 'clicked' ao item clicado
  if (component) {
    component.classList.add('clicked');
  } else if (operation) {
    operation.classList.add('clicked');
  } else if (modalItem) {
    modalItem.classList.add('clicked');
  }
});
   function createFolder(produto, estrutura = null) {
  const folder = document.createElement('div');
  folder.className = 'folder';
  folder.dataset.id = produto.id;

  const creationDate = estrutura?.dataCriacao ? new Date(estrutura.dataCriacao).toLocaleString('pt-BR') : 'Não criada';
  const lastUpdateDate = estrutura?.dataUltimaAlteracao ? new Date(estrutura.dataUltimaAlteracao).toLocaleString('pt-BR') : 'Não alterada';
  const revisionNumber = estrutura?.revisaoAtual ? `REV${String(estrutura.revisaoAtual).padStart(3, '0')}` : 'REV000';
  const lastUser = estrutura?.usuarioUltimaAlteracao?.nome || 'N/A';

  folder.innerHTML = `
    <div style="background-color: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="font-size: 16px; font-weight: 500;">
          ${produto.codigo} - ${produto.descricao} (${produto.tipo})
          <span style="background-color: #1976d2; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
            ${revisionNumber}
          </span>
        </div>
        <button class="btn-danger" onclick="removeFolder(this, event)">X</button>
      </div>
      <div style="font-size: 13px; color: #666;">
        <div>Criado em: ${creationDate}</div>
        <div>Última alteração: ${lastUpdateDate}</div>
        <div>Última alteração por: ${lastUser}</div>
      </div>
    </div>
    <div class="folder-content">
      <div class="folder-section structure-section">
        <div class="section-title">Estrutura (Componentes)</div>
        <div class="components-list"></div>
      </div>
      <div class="folder-section process-section">
        <div class="section-title">Processo (Operações)</div>
        <div class="operations-list"></div>
      </div>
      <button class="btn-primary" onclick="addOperationToFolder(this)" style="margin-top: 5px;">Adicionar Operação</button>
    </div>
  `;

  folder.querySelector('.folder-content').classList.add('open');
  return folder;
}


    window.toggleFolder = function(header) {
      const content = header.nextElementSibling;
      content.classList.toggle('open');
    };

    function addComponentToFolder(folder, produto) {
  const componentsList = folder.querySelector('.components-list');
  const existingComponent = componentsList.querySelector(`.component[data-id="${produto.id}"]`);

  if (existingComponent) {
    return; // Ignora duplicatas
  }

  const components = Array.from(componentsList.querySelectorAll('.component'));
  if (components.some(comp => comp.dataset.id === produto.id)) {
    return;
  }

  if (produto.tipo === 'SP') {
    const hasStructure = estruturas.some(e => e.produtoPaiId === produto.id);
    if (!hasStructure) {
      alert(`Atenção: O Semi-Produto "${produto.codigo} - ${produto.descricao}" foi adicionado, mas não possui uma estrutura definida. Considere criar uma estrutura para este produto.`);
    }
  }

  const component = document.createElement('div');
  component.className = 'component';
  component.dataset.id = produto.id;
  const sequence = componentsList.querySelectorAll('.component').length + 1;

  component.innerHTML = `
    <input type="number" class="sequence-input" placeholder="Seq." min="1" step="1" value="${sequence}" readonly>
    <span>
      ${produto.codigo} - ${produto.descricao} (${produto.tipo})
      ${produto.tipo === 'SP' ? `<span style="cursor: pointer; margin-left: 5px;" onclick="showStructureModal('${produto.id}')">+</span>` : ''}
    </span>
    <div>
      <input type="number" class="quantidade" placeholder="Quant." min="0.001" step="0.001" value="1">
      <span>${produto.unidade}</span>
      <button class="btn-danger" onclick="removeComponent(this)">X</button>
    </div>
  `;
  componentsList.appendChild(component);
  folder.querySelector('.structure-section').classList.add('open');
  hasChanges = true;
  document.querySelector('.btn-success').disabled = false;
}

   window.addOperationToFolder = function(button) {
  const folder = button.closest('.folder');
  const operationsList = folder.querySelector('.operations-list');
  const operation = document.createElement('div');
  operation.className = 'operation';

  // Ordena operações por numero em ordem crescente
  const sortedOperacoes = [...operacoes].sort((a, b) => a.numero.localeCompare(b.numero));
  // Ordena recursos por codigo em ordem crescente
  const sortedRecursos = [...recursos].sort((a, b) => a.codigo.localeCompare(b.codigo));

  operation.innerHTML = `
    <input type="number" class="sequence-input" placeholder="Seq." min="1" step="1" value="${operationsList.querySelectorAll('.operation').length + 1}">
    <select class="operacao" required>
      <option value="">Selecione a operação...</option>
      ${sortedOperacoes.map(op => `<option value="${op.id}">${op.numero} - ${op.operacao}</option>`).join('')}
    </select>
    <select class="recurso" required>
      <option value="">Selecione o recurso...</option>
      ${sortedRecursos.map(rec => `<option value="${rec.id}">${rec.codigo} - ${rec.maquina} (${rec.setor})</option>`).join('')}
    </select>
    <input type="number" class="tempo" placeholder="Tempo (min)" min="0.1" step="0.1" value="1">
    <textarea class="descricao" placeholder="Descrição" maxlength="50" rows="1"></textarea>
    <div class="operation-controls">
      <button type="button" class="move-btn" onclick="moveOperation(this, -1)">↑</button>
      <button type="button" class="move-btn" onclick="moveOperation(this, 1)">↓</button>
      <button class="btn-danger" onclick="removeOperation(this)">X</button>
    </div>
  `;
  operationsList.appendChild(operation);
  folder.querySelector('.process-section').classList.add('open');
  hasChanges = true;
  document.querySelector('.btn-success').disabled = false;
};
    window.moveOperation = function(button, direction) {
      const operation = button.closest('.operation');
      const operationsList = operation.parentElement;
      const operations = Array.from(operationsList.querySelectorAll('.operation'));
      const index = operations.indexOf(operation);
      const newIndex = index + direction;

      if (newIndex >= 0 && newIndex < operations.length) {
        if (direction === 1) {
          operationsList.insertBefore(operations[newIndex], operation);
        } else {
          operationsList.insertBefore(operation, operations[newIndex]);
        }
        updateOperationSequences(operationsList);
        hasChanges = true;
        document.querySelector('.btn-success').disabled = false;
      }
    };

    window.removeFolder = function(button, event) {
      event.stopPropagation();
      if (confirm("Tem certeza que deseja remover esta pasta e seus componentes/operações?")) {
        button.closest('.folder').remove();
        hasChanges = true;
        document.querySelector('.btn-success').disabled = false;
      }
    };

    window.removeComponent = function(button) {
      const componentsList = button.closest('.components-list');
      button.closest('.component').remove();
      updateComponentSequences(componentsList);
      hasChanges = true;
      document.querySelector('.btn-success').disabled = false;
    };

   function updateComponentSequences(componentsList) {
   const components = componentsList.querySelectorAll('.component');
   components.forEach((comp, index) => {
    comp.querySelector('.sequence-input').value = index + 1;
   });
}
    window.removeOperation = function(button) {
      const operationsList = button.closest('.operations-list');
      button.closest('.operation').remove();
      updateOperationSequences(operationsList);
      hasChanges = true;
      document.querySelector('.btn-success').disabled = false;
    };

    function updateOperationSequences(operationsList) {
      const operations = operationsList.querySelectorAll('.operation');
      operations.forEach((op, index) => {
        op.querySelector('.sequence-input').value = index + 1;
      });
    }

    window.saveStructure = async function() {
    const structureTree = document.getElementById('structureTree');
    const folders = structureTree.querySelectorAll('.folder');

    if (folders.length === 0) {
    alert("Selecione um produto pai para criar ou editar a estrutura!");
    return Promise.reject(new Error("Nenhum produto selecionado"));
   }

   const structureData = [];
   const processedIds = new Set();
   let hasDuplicates = false;
   let duplicateMessage = "Os seguintes componentes estão duplicados:\\n";

   function processFolder(folder) {
    const productId = folder.dataset.id;
    if (processedIds.has(productId)) {
      alert(`Ciclo detectado no produto ${productId}. A estrutura não pode conter ciclos.`);
      throw new Error("Ciclo detectado");
    }
    processedIds.add(productId);

    const components = [];
    const componentIds = new Set();
    folder.querySelectorAll('.component').forEach(comp => {
      const componentId = comp.dataset.id;
      const quantidade = parseFloat(comp.querySelector('.quantidade').value) || 1;
      if (quantidade > 0) {
        if (componentIds.has(componentId)) {
          hasDuplicates = true;
          const produto = produtos.find(p => p.id === componentId);
          duplicateMessage += `- ${produto.codigo} - ${produto.descricao} (${produto.tipo})\\n`;
        } else {
          componentIds.add(componentId);
          components.push({
            componentId: componentId,
            quantidade,
            unidade: produtos.find(p => p.id === componentId).unidade
          });
        }
      }
    });

    const operations = [];
    folder.querySelectorAll('.operation').forEach(op => {
      const sequencia = parseInt(op.querySelector('.sequence-input').value) || 1;
      const operacaoId = op.querySelector('.operacao').value;
      const recursoId = op.querySelector('.recurso').value;
      const tempo = parseFloat(op.querySelector('.tempo').value) || 1;
      const descricao = op.querySelector('.descricao').value;
      if (operacaoId && recursoId && tempo > 0) {
        operations.push({
          sequencia,
          operacaoId,
          recursoId,
          tempo,
          descricao: descricao || ''
        });
      }
    });

    const existingStructure = estruturas.find(e => e.produtoPaiId === productId);
    const now = new Date().toISOString();
    structureData.push({
      produtoPaiId: productId,
      componentes: components,
      operacoes: operations,
      dataCriacao: existingStructure?.dataCriacao || now,
      dataUltimaAlteracao: now,
      revisaoAtual: existingStructure ? (existingStructure.revisaoAtual || 0) : 0,
      usuarioUltimaAlteracao: {
        id: usuarioAtual.id,
        nome: usuarioAtual.nome,
        email: usuarioAtual.email
      }
    });
  }

  try {
    folders.forEach(folder => {
      processFolder(folder);
    });

    if (hasDuplicates) {
      duplicateMessage += "\\nPor favor, remova os itens duplicados antes de salvar.";
      alert(duplicateMessage);
      return Promise.reject(new Error("Componentes duplicados"));
    }

    for (const item of structureData) {
      const q = query(collection(db, "estruturas"), where("produtoPaiId", "==", item.produtoPaiId));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        // Estrutura existente - retorna sem salvar
        return { exists: true, data: item };
      } else {
        // Nova estrutura - salva com revisão 0
        const docRef = await addDoc(collection(db, "estruturas"), {
          ...item,
          revisaoAtual: 0
        });

        // Atualiza a lista de estruturas
        estruturas.push({ id: docRef.id, ...item, revisaoAtual: 0 });

        // Retorna indicando que é uma nova estrutura
        return { exists: false, data: { id: docRef.id, ...item, revisaoAtual: 0 } };
      }
    }
  } catch (error) {
    console.error("Erro ao salvar estrutura:", error);
    alert("Erro ao salvar estrutura: " + error.message);
    return Promise.reject(error);
  }
};

// Variável para rastrear a estrutura selecionada no histórico
let selectedStructureId = null;
window.openHistoryModal = function() {
  const historyModal = document.getElementById('historyModal');
  const historyTableBody = document.getElementById('historyTableBody');
  historyTableBody.innerHTML = ''; // Limpa o conteúdo anterior
  selectedStructureId = null; // Reseta a seleção

  if (estruturas.length === 0) {
    historyTableBody.innerHTML = '<tr><td colspan="4" style="padding: 8px; text-align: center;">Nenhuma estrutura encontrada.</td></tr>';
  } else {
    // Ordena as estruturas por data de última alteração (mais recente primeiro)
    const sortedEstruturas = [...estruturas].sort((a, b) => {
      const dateA = a.dataUltimaAlteracao ? new Date(a.dataUltimaAlteracao) : new Date(0);
      const dateB = b.dataUltimaAlteracao ? new Date(b.dataUltimaAlteracao) : new Date(0);
      return dateB - dateA;
    });

    sortedEstruturas.forEach((estrutura, index) => {
      const produtoPai = produtos.find(p => p.id === estrutura.produtoPaiId);
      if (!produtoPai) return; // Pula se o produto pai não for encontrado

      // Trata datas ausentes ou inválidas
      const dataCriacao = estrutura.dataCriacao 
        ? new Date(estrutura.dataCriacao).toLocaleString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          }) 
        : 'Não disponível';
      const dataUltimaAlteracao = estrutura.dataUltimaAlteracao 
        ? new Date(estrutura.dataUltimaAlteracao).toLocaleString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          }) 
        : 'Não alterada';

      const row = document.createElement('tr');
      row.dataset.structureId = estrutura.id;
      row.innerHTML = `
        <td style="padding: 8px;">${produtoPai.codigo || 'N/A'}</td>
        <td style="padding: 8px;">${produtoPai.descricao || 'Sem descrição'}</td>
        <td style="padding: 8px;">${dataCriacao}</td>
        <td style="padding: 8px;">${dataUltimaAlteracao}</td>
      `;

      // Adiciona evento de clique para seleção
      row.addEventListener('click', () => {
        const previouslySelected = historyTableBody.querySelector('.selected');
        if (previouslySelected) previouslySelected.classList.remove('selected');
        row.classList.add('selected');
        selectedStructureId = estrutura.id;
      });

      // Adiciona evento de duplo clique para carregar diretamente
      row.addEventListener('dblclick', () => {
        selectedStructureId = estrutura.id;
        loadSelectedStructure();
      });

      historyTableBody.appendChild(row);
    });
  }

  historyModal.style.display = 'block';
};

window.closeHistoryModal = function() {
  document.getElementById('historyModal').style.display = 'none';
  selectedStructureId = null;
};

window.loadSelectedStructure = function() {
  if (!selectedStructureId) {
    alert("Por favor, selecione uma estrutura no histórico clicando em uma linha.");
    return;
  }

  const estrutura = estruturas.find(e => e.id === selectedStructureId);
  if (!estrutura) {
    alert("Estrutura selecionada não encontrada.");
    return;
  }

  const produtoPai = produtos.find(p => p.id === estrutura.produtoPaiId);
  if (!produtoPai) {
    alert("Produto pai associado à estrutura não encontrado.");
    return;
  }

  try {
    // Define o produto pai no select
    const parentSelect = document.getElementById('parentProductSelect');
    parentSelect.value = produtoPai.id;

    // Carrega a estrutura na tela
    const structureTree = document.getElementById('structureTree');
    structureTree.innerHTML = '';
    const folder = createFolder(produtoPai, estrutura);
    populateFolderWithStructure(folder, estrutura);
    structureTree.appendChild(folder);

    // Reconfigura drag and drop e listeners
    setupDragAndDrop();
    setupChangeListeners(folder);

    // Reseta estado de alterações
    hasChanges = false;
    initialStructureState = JSON.parse(JSON.stringify({
      componentes: estrutura.componentes || [],
      operacoes: estrutura.operacoes || []
    }));
    document.querySelector('.btn-success').disabled = true;

    closeHistoryModal();
  } catch (error) {
    console.error("Erro ao carregar estrutura:", error);
    alert("Erro ao carregar a estrutura selecionada: " + error.message);
  }
};
window.deleteCurrentStructure = async function() {
  const structureTree = document.getElementById('structureTree');
  const folder = structureTree.querySelector('.folder');

  if (!folder) {
    alert("Nenhuma estrutura está carregada. Selecione um produto pai para excluir sua estrutura.");
    return;
  }

  const productId = folder.dataset.id;
  const produtoPai = produtos.find(p => p.id === productId);
  if (!produtoPai) {
    alert("Produto pai não encontrado.");
    return;
  }

  const estrutura = estruturas.find(e => e.produtoPaiId === productId);
  if (!estrutura) {
    alert(`Nenhuma estrutura registrada encontrada para o produto "${produtoPai.codigo} - ${produtoPai.descricao}".`);
    return;
  }

  try {
    // Verificação 1: Estrutura tem componentes?
    if (estrutura.componentes && estrutura.componentes.length > 0) {
      alert(`A estrutura do produto "${produtoPai.codigo} - ${produtoPai.descricao}" não pode ser excluída pois possui componentes associados. Remova os componentes antes de excluir.`);
      return;
    }

    // Verificação 2: Estrutura é usada como componente em outra estrutura?
    const isComponentInOtherStructure = estruturas.some(otherStructure => 
      otherStructure.componentes && 
      otherStructure.componentes.some(comp => comp.componentId === productId) &&
      otherStructure.id !== estrutura.id
    );
    if (isComponentInOtherStructure) {
      alert(`A estrutura do produto "${produtoPai.codigo} - ${produtoPai.descricao}" não pode ser excluída pois é usada como componente em outra estrutura.`);
      return;
    }

    // Verificação 3: Existem ordens de produção abertas para este produto?
    const ordensSnapshot = await getDocs(query(
      collection(db, "ordensProducao"), 
      where("produtoId", "==", productId), 
      where("status", "==", "aberta")
    ));
    if (!ordensSnapshot.empty) {
      alert(`A estrutura do produto "${produtoPai.codigo} - ${produtoPai.descricao}" não pode ser excluída pois existem ordens de produção abertas associadas.`);
      return;
    }

    // Confirmação do usuário
    if (!confirm(`Tem certeza que deseja excluir a estrutura do produto "${produtoPai.codigo} - ${produtoPai.descricao}"? Esta ação não pode ser desfeita.`)) {
      return;
    }

    // Exclui a estrutura do Firestore
    await deleteDoc(doc(db, "estruturas", estrutura.id));

    // Remove da lista local
    estruturas = estruturas.filter(e => e.id !== estrutura.id);

    // Limpa a interface
    structureTree.innerHTML = '';
    document.getElementById('parentProductSelect').value = '';
    document.querySelector('.btn-success').disabled = true;
    hasChanges = false;

    // Atualiza os dados
    await carregarDados();

    alert("Estrutura excluída com sucesso!");
  } catch (error) {
    console.error("Erro ao excluir estrutura:", error);
    alert("Erro ao excluir a estrutura: " + error.message);
  }
};

// Variável global para rastrear o produto atual no modal
let currentModalProductId = null;

window.showStructureModal = function(productId) {
  currentModalProductId = productId;
  const produto = produtos.find(p => p.id === productId);
  const estrutura = estruturas.find(e => e.produtoPaiId === productId);
  const modal = document.getElementById('structureModal');
  const modalContent = modal.querySelector('.modal-content');

  modalContent.querySelector('.sap-title').textContent = `Estrutura e Processo: ${produto.codigo} - ${produto.descricao}`;

  // Preenche a lista de componentes
  const componentsList = modalContent.querySelector('.components-list');
  componentsList.innerHTML = '';
  if (estrutura?.componentes?.length > 0) {
    estrutura.componentes.forEach((comp, index) => {
      const compProduto = produtos.find(p => p.id === comp.componentId);
      if (compProduto) {
        componentsList.innerHTML += `
          <div class="component" data-id="${comp.componentId}">
            <input type="number" class="sequence-input" value="${index + 1}" readonly>
            <span>${compProduto.codigo} - ${compProduto.descricao} (${compProduto.tipo})</span>
            <div>
              <input type="number" class="quantidade" value="${comp.quantidade}" min="0.001" step="0.001">
              <span>${compProduto.unidade}</span>
              <button class="btn-danger" onclick="removeComponentFromModal(this)">X</button>
            </div>
          </div>
        `;
      }
    });
  } else {
    componentsList.innerHTML = '<div class="modal-item" style="color: #666;">Nenhum componente</div>';
  }

  // Preenche a lista de operações
  const operationsList = modalContent.querySelector('.operations-list');
  operationsList.innerHTML = '';
  if (estrutura?.operacoes?.length > 0) {
    const sortedOperacoes = [...operacoes].sort((a, b) => a.numero.localeCompare(b.numero));
    const sortedRecursos = [...recursos].sort((a, b) => a.codigo.localeCompare(b.codigo));
    estrutura.operacoes.forEach((op, index) => {
      operationsList.innerHTML += `
        <div class="operation">
          <input type="number" class="sequence-input" value="${op.sequencia}" min="1" step="1">
          <select class="operacao">
            <option value="">Selecione a operação...</option>
            ${sortedOperacoes.map(o => `<option value="${o.id}" ${o.id === op.operacaoId ? 'selected' : ''}>${o.numero} - ${o.operacao}</option>`).join('')}
          </select>
          <select class="recurso">
            <option value="">Selecione o recurso...</option>
            ${sortedRecursos.map(r => `<option value="${r.id}" ${r.id === op.recursoId ? 'selected' : ''}>${r.codigo} - ${r.maquina} (${r.setor})</option>`).join('')}
          </select>
          <input type="number" class="tempo" value="${op.tempo}" min="0.1" step="0.1">
          <textarea class="descricao" maxlength="50" rows="1">${op.descricao || ''}</textarea>
          <div class="operation-controls">
            <button class="move-btn" onclick="moveOperationInModal(this, -1)">↑</button>
            <button class="move-btn" onclick="moveOperationInModal(this, 1)">↓</button>
            <button class="btn-danger" onclick="removeOperationFromModal(this)">X</button>
          </div>
        </div>
      `;
    });
  } else {
    operationsList.innerHTML = '<div class="modal-item" style="color: #666;">Nenhuma operação</div>';
  }

  modal.style.display = 'block';
};

window.closeStructureModal = function() {
  document.getElementById('structureModal').style.display = 'none';
  currentModalProductId = null;
};

window.addComponentToModal = function() {
  const componentsList = document.querySelector('#structureModal .components-list');
  const selectOptions = produtos
    .filter(p => p.id !== currentModalProductId && !['PA'].includes(p.tipo))
    .map(p => `<option value="${p.id}">${p.codigo} - ${p.descricao} (${p.tipo})</option>`).join('');

  const component = document.createElement('div');
  component.className = 'component';
  component.innerHTML = `
    <input type="number" class="sequence-input" value="${componentsList.querySelectorAll('.component').length + 1}" readonly>
    <select class="component-select" onchange="updateComponentUnit(this)">
      <option value="">Selecione o componente...</option>
      ${selectOptions}
    </select>
    <div>
      <input type="number" class="quantidade" value="1" min="0.001" step="0.001">
      <span class="unit"></span>
      <button class="btn-danger" onclick="removeComponentFromModal(this)">X</button>
    </div>
  `;
  componentsList.appendChild(component);
};

window.updateComponentUnit = function(select) {
  const componentDiv = select.closest('.component');
  const productId = select.value;
  const produto = produtos.find(p => p.id === productId);
  componentDiv.querySelector('.unit').textContent = produto ? produto.unidade : '';
  componentDiv.dataset.id = productId;
};

window.removeComponentFromModal = function(button) {
  const componentsList = button.closest('.components-list');
  button.closest('.component').remove();
  updateModalComponentSequences(componentsList);
};

function updateModalComponentSequences(componentsList) {
  componentsList.querySelectorAll('.component').forEach((comp, index) => {
    comp.querySelector('.sequence-input').value = index + 1;
  });
}

window.addOperationToModal = function() {
  const operationsList = document.querySelector('#structureModal .operations-list');
  const sortedOperacoes = [...operacoes].sort((a, b) => a.numero.localeCompare(b.numero));
  const sortedRecursos = [...recursos].sort((a, b) => a.codigo.localeCompare(b.codigo));

  const operation = document.createElement('div');
  operation.className = 'operation';
  operation.innerHTML = `
    <input type="number" class="sequence-input" value="${operationsList.querySelectorAll('.operation').length + 1}" min="1" step="1">
    <select class="operacao" required>
      <option value="">Selecione a operação...</option>
      ${sortedOperacoes.map(op => `<option value="${op.id}">${op.numero} - ${op.operacao}</option>`).join('')}
    </select>
    <select class="recurso" required>
      <option value="">Selecione o recurso...</option>
      ${sortedRecursos.map(rec => `<option value="${rec.id}">${rec.codigo} - ${rec.maquina} (${rec.setor})</option>`).join('')}
    </select>
    <input type="number" class="tempo" value="1" min="0.1" step="0.1">
    <textarea class="descricao" maxlength="50" rows="1"></textarea>
    <div class="operation-controls">
      <button class="move-btn" onclick="moveOperationInModal(this, -1)">↑</button>
      <button class="move-btn" onclick="moveOperationInModal(this, 1)">↓</button>
      <button class="btn-danger" onclick="removeOperationFromModal(this)">X</button>
    </div>
  `;
  operationsList.appendChild(operation);
};

window.moveOperationInModal = function(button, direction) {
  const operation = button.closest('.operation');
  const operationsList = operation.parentElement;
  const operations = Array.from(operationsList.querySelectorAll('.operation'));
  const index = operations.indexOf(operation);
  const newIndex = index + direction;

  if (newIndex >= 0 && newIndex < operations.length) {
    if (direction === 1) {
      operationsList.insertBefore(operations[newIndex], operation);
    } else {
      operationsList.insertBefore(operation, operations[newIndex]);
    }
    updateModalOperationSequences(operationsList);
  }
};

window.removeOperationFromModal = function(button) {
  const operationsList = button.closest('.operations-list');
  button.closest('.operation').remove();
  updateModalOperationSequences(operationsList);
};

function updateModalOperationSequences(operationsList) {
  operationsList.querySelectorAll('.operation').forEach((op, index) => {
    op.querySelector('.sequence-input').value = index + 1;
  });
}

window.saveStructureFromModal = async function() {
  if (!currentModalProductId) {
    alert("Nenhum produto selecionado para salvar a estrutura.");
    return;
  }

  const componentsList = document.querySelector('#structureModal .components-list');
  const operationsList = document.querySelector('#structureModal .operations-list');

  // Validação: precisa ter pelo menos um componente OU uma operação
  const hasComponents = componentsList.querySelectorAll('.component').length > 0;
  const hasOperations = operationsList.querySelectorAll('.operation').length > 0;
  if (!hasComponents && !hasOperations) {
    alert('A estrutura deve conter pelo menos um componente ou uma operação para ser salva.');
    return;
  }

  const components = [];
  componentsList.querySelectorAll('.component').forEach(comp => {
    const componentId = comp.dataset.id || comp.querySelector('.component-select')?.value;
    const quantidade = parseFloat(comp.querySelector('.quantidade').value) || 1;
    if (componentId && quantidade > 0) {
      const produto = produtos.find(p => p.id === componentId);
      components.push({
        componentId,
        quantidade,
        unidade: produto.unidade
      });
    }
  });

  const operations = [];
  operationsList.querySelectorAll('.operation').forEach(op => {
    const sequencia = parseInt(op.querySelector('.sequence-input').value) || 1;
    const operacaoId = op.querySelector('.operacao').value;
    const recursoId = op.querySelector('.recurso').value;
    const tempo = parseFloat(op.querySelector('.tempo').value) || 1;
    const descricao = op.querySelector('.descricao').value;
    if (operacaoId && recursoId && tempo > 0) {
      operations.push({
        sequencia,
        operacaoId,
        recursoId,
        tempo,
        descricao: descricao || ''
      });
    }
  });

  const now = new Date().toISOString();
  const structureData = {
    produtoPaiId: currentModalProductId,
    componentes: components, // Corrigido de 'componentes' para 'components'
    operacoes: operations,  // Mantido como 'operations' para consistência
    dataCriacao: estruturas.find(e => e.produtoPaiId === currentModalProductId)?.dataCriacao || now,
    dataUltimaAlteracao: now
  };

  try {
    const q = query(collection(db, "estruturas"), where("produtoPaiId", "==", currentModalProductId));
    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) {
      const docId = querySnapshot.docs[0].id;
      await updateDoc(doc(db, "estruturas", docId), structureData);
      const index = estruturas.findIndex(e => e.id === docId);
      if (index !== -1) estruturas[index] = { id: docId, ...structureData };
    } else {
      const docRef = await addDoc(collection(db, "estruturas"), structureData);
      structureData.id = docRef.id;
      estruturas.push(structureData);
    }

    await carregarDados();
    closeStructureModal();
    alert("Estrutura salva com sucesso!");

    // Recarregar a estrutura principal se o produto estiver aberto
    const parentSelect = document.getElementById('parentProductSelect');
    if (parentSelect.value === currentModalProductId) {
      loadStructureForProduct();
    }
  } catch (error) {
    console.error("Erro ao salvar estrutura do modal:", error);
    alert("Erro ao salvar a estrutura: " + error.message);
  }
};

window.closeStructureModal = function() {
  document.getElementById('structureModal').style.display = 'none';
};
// Adicionar evento de clique para componentes e operações
document.addEventListener('click', function(e) {
  const component = e.target.closest('.component');
  const operation = e.target.closest('.operation');
  const modalItem = e.target.closest('.modal-item');

  // Remove classe 'clicked' de todos os itens
  document.querySelectorAll('.component.clicked, .operation.clicked, .modal-item.clicked').forEach(item => {
    item.classList.remove('clicked');
  });

  // Adiciona classe 'clicked' ao item clicado
  if (component) {
    component.classList.add('clicked');
  } else if (operation) {
    operation.classList.add('clicked');
  } else if (modalItem) {
    modalItem.classList.add('clicked');
  }
});

// Abrir o modal de desenho
window.openDrawingModal = async function(codigo, pdfLink) {
  console.log(`Abrindo visualização para ${codigo} com link: ${pdfLink}`);
  const modal = document.getElementById('drawingModal');
  const title = document.getElementById('drawingModalTitle');
  const canvas = document.getElementById('drawingImage');
  const context = canvas.getContext('2d');

  title.textContent = `Visualização do Desenho: ${codigo}`;
  // Clear previous drawing
  context.clearRect(0, 0, canvas.width, canvas.height);

  if (!pdfLink) {
    title.textContent = `Visualização do Desenho: ${codigo} (Nenhum desenho disponível)`;
    // Optionally, draw a "No preview" message on the canvas
    context.fillText('Nenhum desenho disponível', 10, 50);
    modal.style.display = 'block';
    // alert(`Nenhum PDF associado ao código ${codigo}.`); // Alert can be removed if modal shows info
    return;
  }

  modal.style.display = 'block'; // Display modal while loading
  showLoading(true); // Show a general loading indicator

  try {
    const loadingTask = pdfjsLib.getDocument(pdfLink);
    const pdf = await loadingTask.promise;
    const pageNumber = 1;
    const page = await pdf.getPage(pageNumber);

    const viewport = page.getViewport({ scale: 1.5 });
    // Adjust canvas dimensions to match the PDF page aspect ratio
    const desiredWidth = canvas.parentElement.clientWidth * 0.95; // Fit to 95% of parent container width
    const scale = desiredWidth / viewport.width;
    const scaledViewport = page.getViewport({ scale: scale });

    canvas.height = scaledViewport.height;
    canvas.width = scaledViewport.width;

    const renderContext = {
      canvasContext: context,
      viewport: scaledViewport
    };
    await page.render(renderContext).promise;
    showLoading(false);
  } catch (error) {
    console.error(`Erro ao carregar PDF (${codigo}):`, error);
    title.textContent = `Visualização do Desenho: ${codigo} (Erro ao carregar preview)`;
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.fillText('Erro ao carregar preview do PDF.', 10, 50);
    showLoading(false);
    // alert(`Erro ao carregar o PDF para ${codigo}: ${error.message}`);
  }
};

// Fechar o modal de desenho
window.closeDrawingModal = function() {
  document.getElementById('drawingModal').style.display = 'none';
};

window.updateProductCost = async function(productId, newCost) {
  try {
    if (!confirm('Deseja atualizar o custo médio do produto com o valor calculado?')) {
      return;
    }

    const productRef = doc(db, "produtos", productId);
    await updateDoc(productRef, {
      custoMedio: newCost,
      dataUltimoCusto: new Date().toISOString()
    });

    // Atualiza o array local de produtos
    const produtoIndex = produtos.findIndex(p => p.id === productId);
    if (produtoIndex !== -1) {
      produtos[produtoIndex].custoMedio = newCost;
      produtos[produtoIndex].dataUltimoCusto = new Date().toISOString();
    }

    alert('Custo médio atualizado com sucesso!');
  } catch (error) {
    console.error("Erro ao atualizar custo:", error);
    alert("Erro ao atualizar custo do produto");
  }
};

async function calcularCustoMedio(produtoId) {
  // Implementação para calcular o custo médio de um produto
  // Você precisará acessar seus dados e calcular o custo médio aqui.
  // Exemplo (substitua pela sua lógica):
  const produto = produtos.find(p => p.id === produtoId);
  if (produto && produto.custoUnitario) return produto.custoUnitario;
  return 0; // Retorna 0 se não encontrar o produto ou o custo
}


async function buildCostStructure(productId, level = 0, quantidade = 1) {
  const produto = produtos.find(p => p.id === productId);
  const estrutura = estruturas.find(e => e.produtoPaiId === productId);
  let semCusto = [];

  let custoMaterial = 0;
  let custoOperacoes = 0;

  const node = {
    produto,
    level,
    children: [],
    operacoes: [],
    quantidade,
    custos: {
      material: 0,
      operacoes: 0,
      total: 0,
      unitario: 0
    },
    avisos: []
  };

  // Verifica se produto MP tem custo
  if (produto.tipo === 'MP' && (!produto.custoUnitario || produto.custoUnitario === 0)) {
    node.avisos.push(`Matéria prima ${produto.codigo} sem custo definido`);
  }

  // Adiciona custo unitário do produto se for MP
  if (produto.tipo === 'MP') {
    custoMaterial = (produto.custoUnitario || 0) * quantidade;
  }

  // Calcula custo das operações
  if (estrutura?.operacoes) {
    for (const op of estrutura.operacoes) {
      const recurso = recursos.find(r => r.id === op.recursoId);
      if (recurso && recurso.custoHora) {
        const custoOperacao = (op.tempo / 60) * recurso.custoHora * quantidade;
        custoOperacoes += custoOperacao;

        node.operacoes.push({
          operacao: operacoes.find(o => o.id === op.operacaoId),
          recurso,
          tempo: op.tempo,
          custo: custoOperacao
        });
      }
    }
  }

  // Calcula custo dos componentes
  if (estrutura?.componentes) {
    for (const comp of estrutura.componentes) {
      const componenteProduto = produtos.find(p => p.id === comp.componentId);
      if (componenteProduto) {
        const quantidadeTotal = comp.quantidade * quantidade;

        if (componenteProduto.tipo === 'SP' || componenteProduto.tipo === 'PA') {
          const childNode = await buildCostStructure(comp.componentId, level + 1, quantidadeTotal);
          childNode.quantidade = quantidadeTotal;
          node.children.push(childNode);
          custoMaterial += childNode.custos.total;
        } else {
          const custoUnitario = await calcularCustoMedio(comp.componentId);
          const custoTotal = custoUnitario * quantidadeTotal;
          custoMaterial += custoTotal;

          node.children.push({
            produto: componenteProduto,
            quantidade: quantidadeTotal,
            custoUnitario,
            custoTotal,
            level: level + 1
          });
        }
      }
    }
  }

  node.custos = {
    material: custoMaterial,
    operacoes: custoOperacoes,
    total: custoMaterial + custoOperacoes
  };
  return node;
}

async function loadStructureForProduct() {
  const productId = document.getElementById('parentProductSelect').value;
  const structureTree = document.getElementById('structureTree');
  const saveButton = document.querySelector('.btn-success');

  structureTree.innerHTML = '';
  saveButton.disabled = true;
  initialStructureState = null;
  hasChanges = false;

  if (!productId) return Promise.reject(new Error("Nenhum produto selecionado"));

  try {
    const produtoPai = produtos.find(p => p.id === productId);
    const existingStructure = estruturas.find(e => e.produtoPaiId === productId);

    if (produtoPai) {
      const folder = createFolder(produtoPai, existingStructure);
      if (existingStructure) {
        populateFolderWithStructure(folder, existingStructure);
        initialStructureState = JSON.parse(JSON.stringify({
          componentes: existingStructure.componentes || [],
          operacoes: existingStructure.operacoes || []
        }));
      } else {
        saveButton.disabled = false;
      }
      structureTree.appendChild(folder);
      setupDragAndDrop();
      setupChangeListeners(folder);
      return Promise.resolve({ produtoPai, estrutura: existingStructure });
    } else {
      console.error("Produto pai não encontrado para ID:", productId);
      return Promise.reject(new Error("Produto pai não encontrado"));
    }
  } catch (error) {
    console.error("Erro ao carregar estrutura:", error);
    return Promise.reject(error);
  }
}


function populateFolderWithCostStructure(folder, costStructure) {
  const componentsList = folder.querySelector('.components-list');
  const operationsList = folder.querySelector('.operations-list');
  const produto = produtos.find(p => p.id === costStructure.produto.id);

  // Exibe avisos se houver
  if (costStructure.avisos && costStructure.avisos.length > 0) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'warning-summary';
    warningDiv.style.color = '#ff6b6b';
    warningDiv.style.padding = '10px';
    warningDiv.style.marginBottom = '10px';
    warningDiv.innerHTML = `
      <strong>Atenção:</strong><br>
      ${costStructure.avisos.join('<br>')}
    `;
    folder.insertBefore(warningDiv, folder.firstChild);
  }

  const costSummary = document.createElement('div');
  costSummary.className = 'cost-summary';
  const custoUnitario = costStructure.custos.total / (costStructure.quantidade || 1);
  costSummary.innerHTML = `
    <div class="cost-badge">Custo Material: R$ ${costStructure.custos.material.toFixed(2)}</div>
    <div class="cost-badge">Custo Operações: R$ ${costStructure.custos.operacoes.toFixed(2)}</div>
    <div class="cost-badge cost-badge-total">Custo Total: R$ ${costStructure.custos.total.toFixed(2)}</div>
    <div class="cost-badge cost-badge-unit">
      Custo Unitário: R$ ${custoUnitario.toFixed(2)}
      <button onclick="updateProductCost('${costStructure.produto.id}', ${custoUnitario})" 
              class="btn-primary" style="margin-left: 10px; padding: 2px 5px; font-size: 12px;">
        Atualizar Custo Médio
      </button>
    </div>
  `;
  folder.insertBefore(costSummary, folder.querySelector('.folder-content'));

  // Adiciona operações
  costStructure.operacoes.forEach(op => {
    const operation = document.createElement('div');
    operation.className = 'operation';
    operation.innerHTML = `
      <span>${op.operacao.numero} - ${op.operacao.operacao}</span>
      <span>${op.recurso.codigo} - ${op.recurso.maquina}</span>
      <span>${op.tempo} min</span>
      <span>R$ ${op.custo.toFixed(2)}</span>
    `;
    operationsList.appendChild(operation);
    folder.querySelector('.process-section').classList.add('open');
  });

  // Adiciona componentes recursivamente
  function addComponent(comp) {
    const component = document.createElement('div');
    component.className = 'component';
    component.innerHTML = `
      <span>${comp.produto.codigo} - ${comp.produto.descricao}</span>
      <span>${comp.quantidade} ${comp.produto.unidade}</span>
      <span>R$ ${comp.custoTotal.toFixed(2)}</span>
    `;
    componentsList.appendChild(component);
    folder.querySelector('.structure-section').classList.add('open');

    if (comp.children) {
      comp.children.forEach(child => addComponent(child));
    }
  }

  costStructure.children.forEach(comp => addComponent(comp));
}


function createTreeNode(node) {
  const div = document.createElement('div');
  div.className = `tree-item ${node.level > 0 ? 'tree-item-child' : ''}`;

  // Informações do produto
  const produtoInfo = document.createElement('div');
  produtoInfo.innerHTML = `
    <strong>${node.produto.codigo} - ${node.produto.descricao}</strong>
    ${node.quantidade ? ` (${node.quantidade} ${node.produto.unidade})` : ''}
    <div class="cost-summary">
      <span class="cost-badge">
        Custo Material: R$ ${node.custos.material.toFixed(2)}
      </span>
      <span class="cost-badge">
        Custo Operações: R$ ${node.custos.operacoes.toFixed(2)}
      </span>
      <span class="cost-badge cost-badge-total">
        Custo Total: R$ ${node.custos.total.toFixed(2)}
      </span>
      ${node.quantidade > 1 ? `
        <span class="cost-badge cost-badge-unit">
          Custo Unitário: R$ ${(node.custos.total / node.quantidade).toFixed(2)}
        </span>
      ` : ''}
    </div>
  `;
  div.appendChild(produtoInfo);

  // Adiciona filhos recursivamente
  node.children.forEach(child => div.appendChild(createTreeNode(child)));
  return div;
}

function calcularCustos(estrutura) {
  let custoMaterial = 0;
  let custoMaoDeObra = 0;

  if (estrutura && estrutura.componentes) {
    estrutura.componentes.forEach(componente => {
      const produto = produtos.find(p => p.id === componente.componentId);
      if (produto && produto.custoUnitario) {
        custoMaterial += produto.custoUnitario * componente.quantidade;
      }
    });
  }

  if (estrutura && estrutura.operacoes) {
    estrutura.operacoes.forEach(operacao => {
      const recurso = recursos.find(r => r.id === operacao.recursoId);
      if (recurso && recurso.custoHora) {
        custoMaoDeObra += (operacao.tempo / 60) * recurso.custoHora;
      }
    });
  }

  return {
    material: custoMaterial,
    maoDeObra: custoMaoDeObra,
    total: custoMaterial + custoMaoDeObra
  };
}

/* Adicionar ao JavaScript existente */
let selectedUsageProductId = null;
const usageModal = document.getElementById('usageModal');
const usageSearchInput = document.getElementById('usageSearchInput');
const usageSearchResults = document.getElementById('usageSearchResults');
let usageSearchTimeout = null;

function openUsageModal() {
  usageModal.style.display = 'block';
}

function closeUsageModal() {
  usageModal.style.display = 'none';
  usageSearchInput.value = '';
  usageSearchResults.style.display = 'none';
  document.getElementById('usageReportContent').innerHTML = '';
}

// Busca otimizada de produtos
async function searchUsageProducts(searchText) {
  const usageSearchResults = document.getElementById('usageSearchResults');

  if (!searchText || searchText.length < 2) {
    usageSearchResults.style.display = 'none';
    return;
  }

  usageSearchResults.innerHTML = '<div class="search-result-item" style="text-align: center;">Buscando...</div>';
  usageSearchResults.style.display = 'block';

  try {
    const searchLower = searchText.toLowerCase();

    // Filtra os produtos já carregados em memória em vez de fazer nova consulta
    const produtosFiltrados = produtos.filter(produto => 
      (produto.tipo === 'MP' || produto.tipo === 'SP') &&
      (produto.codigo?.toLowerCase().includes(searchLower) || 
       produto.descricao?.toLowerCase().includes(searchLower))
    ).slice(0, 10);

    if (produtosFiltrados.length > 0) {
      usageSearchResults.innerHTML = '';
      produtosFiltrados.forEach(produto => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.textContent = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
        div.onclick = () => selectUsageProduct(produto);
        usageSearchResults.appendChild(div);
      });
    } else {
      usageSearchResults.innerHTML = '<div class="search-result-item" style="text-align: center;">Nenhum produto encontrado</div>';
    }
  } catch (error) {
    console.error("Erro na busca:", error);
    usageSearchResults.innerHTML = '<div class="search-result-item" style="color: red; text-align: center;">Erro ao buscar produtos. Tente novamente.</div>';
  }
};

function displayUsageSearchResults(produtos) {
  usageSearchResults.innerHTML = '';

  if (produtos.length > 0) {
    produtos.forEach(produto => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.textContent = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
      div.onclick = () => selectUsageProduct(produto);
      usageSearchResults.appendChild(div);
    });
    usageSearchResults.style.display = 'block';
  } else {
    usageSearchResults.style.display = 'none';
  }
}

function selectUsageProduct(produto) {
  selectedUsageProductId = produto.id;
  usageSearchInput.value = `${produto.codigo} - ${produto.descricao}`;
  usageSearchResults.style.display = 'none';
  generateUsageReport();
}

async function generateUsageReport() {
  if (!selectedUsageProductId) {
    document.getElementById('usageReportContent').innerHTML = 
      '<div class="no-results">Selecione um produto para ver onde é usado.</div>';
    return;
  }

  showLoading(true);
  try {
    const estruturasRef = collection(db, "estruturas");
    const estruturasQuery = query(estruturasRef);
    const estruturasSnap = await getDocs(estruturasQuery);

    const produtoRef = collection(db, "produtos");
    const produtoQuery = query(produtoRef, where("__name__", "==", selectedUsageProductId));
    const produtoSnap = await getDocs(produtoQuery);

    if (produtoSnap.empty) {
      throw new Error("Produto não encontrado");
    }

    const produto = { id: produtoSnap.docs[0].id, ...produtoSnap.docs[0].data() };

    const estruturas = estruturasSnap.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .filter(estrutura => 
        estrutura.componentes?.some(comp => comp.componentId === selectedUsageProductId)
      );

    renderUsageReport(produto, estruturas);
  } catch (error) {
    console.error("Erro ao gerar relatório:", error);
    document.getElementById('usageReportContent').innerHTML = 
      '<div class="error-message">Erro ao gerar relatório. Tente novamente.</div>';
  } finally {
    showLoading(false);
  }
}

async function renderUsageReport(produto, estruturas) {
  const reportContent = document.getElementById('usageReportContent');

  let html = `
    <div class="summary-box">
      <h3>Resumo do Produto</h3>
      <div class="usage-info">
        <strong>Código:</strong> ${produto.codigo}<br>
        <strong>Descrição:</strong> ${produto.descricao}<br>
        <strong>Tipo:</strong> ${produto.tipo}<br>
        <strong>Unidade:</strong> ${produto.unidade}
      </div>
      <div class="summary-info">
        <div class="summary-item">
          <div class="summary-value">${estruturas.length}</div>
          <div class="summary-label">Total de Utilizações</div>
        </div>
      </div>
    </div>
  `;

  if (estruturas.length === 0) {
    html += '<div class="no-results">Este produto não é utilizado em nenhuma estrutura.</div>';
  } else {
    html += `
      <div class="table-responsive">
        <table class="usage-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Descrição</th>
              <th>Tipo</th>
              <th>Quantidade</th>
              <th>Unidade</th>
            </tr>
          </thead>
          <tbody>
    `;

    // Carregar produtos pais
    const produtosIds = estruturas.map(e => e.produtoPaiId);
    const produtosSnap = await getDocs(
      query(collection(db, "produtos"), where("__name__", "in", produtosIds))
    );
    const produtosMap = {};
    produtosSnap.forEach(doc => {
      produtosMap[doc.id] = { id: doc.id, ...doc.data() };
    });

    estruturas.forEach(estrutura => {
      const produtoPai = produtosMap[estrutura.produtoPaiId];
      if (produtoPai) {
        const componente = estrutura.componentes.find(c => c.componentId === selectedUsageProductId);
        html += `
          <tr>
            <td>${produtoPai.codigo}</td>
            <td>${produtoPai.descricao}</td>
            <td>${produtoPai.tipo}</td>
            <td style="text-align: right">${componente.quantidade.toFixed(2)}</td>
            <td>${componente.unidade}</td>
          </tr>
        `;
      }
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  }

  reportContent.innerHTML = html;
}

// Event listeners
usageSearchInput.addEventListener('input', (e) => {
  clearTimeout(usageSearchTimeout);
  usageSearchTimeout = setTimeout(() => searchUsageProducts(e.target.value), 300);
});

document.addEventListener('click', (e) => {
  if (!usageSearchResults.contains(e.target) && e.target !== usageSearchInput) {
    usageSearchResults.style.display = 'none';
  }
});

// Fechar modal quando clicar fora
window.onclick = function(event) {
  if (event.target == usageModal) {
    closeUsageModal();
  }
}

// ... existing code ...
/* Adicionar ao JavaScript existente */
window.openUsageModal = function() {
  document.getElementById('usageModal').style.display = 'block';
  document.getElementById('usageSearchInput').value = '';
  document.getElementById('usageSearchResults').style.display = 'none';
  document.getElementById('usageReportContent').innerHTML = '';
};

window.closeUsageModal = function() {
  document.getElementById('usageModal').style.display = 'none';
  document.getElementById('usageSearchInput').value = '';
  document.getElementById('usageSearchResults').style.display = 'none';
  document.getElementById('usageReportContent').innerHTML = '';
};

window.searchUsageProducts = async function(searchText) {
  const usageSearchResults = document.getElementById('usageSearchResults');

  if (!searchText || searchText.length < 2) {
    usageSearchResults.style.display = 'none';
    return;
  }

  usageSearchResults.innerHTML = '<div class="search-result-item" style="text-align: center;">Buscando...</div>';
  usageSearchResults.style.display = 'block';

  try {
    const searchLower = searchText.toLowerCase();

    // Filtra os produtos já carregados em memória em vez de fazer nova consulta
    const produtosFiltrados = produtos.filter(produto => 
      (produto.tipo === 'MP' || produto.tipo === 'SP') &&
      (produto.codigo?.toLowerCase().includes(searchLower) || 
       produto.descricao?.toLowerCase().includes(searchLower))
    ).slice(0, 10);

    if (produtosFiltrados.length > 0) {
      usageSearchResults.innerHTML = '';
      produtosFiltrados.forEach(produto => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.textContent = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
        div.onclick = () => selectUsageProduct(produto);
        usageSearchResults.appendChild(div);
      });
    } else {
      usageSearchResults.innerHTML = '<div class="search-result-item" style="text-align: center;">Nenhum produto encontrado</div>';
    }
  } catch (error) {
    console.error("Erro na busca:", error);
    usageSearchResults.innerHTML = '<div class="search-result-item" style="color: red; text-align: center;">Erro ao buscar produtos. Tente novamente.</div>';
  }
};

window.generateUsageReport = async function() {
  const reportContent = document.getElementById('usageReportContent');

  if (!selectedUsageProductId) {
    reportContent.innerHTML = '<div class="no-results">Selecione um produto para ver onde é usado.</div>';
    return;
  }

  reportContent.innerHTML = '<div style="text-align: center; padding: 20px;">Gerando relatório...</div>';

  try {
    // Busca o produto selecionado
    const produto = produtos.find(p => p.id === selectedUsageProductId);
    if (!produto) {
      throw new Error("Produto não encontrado");
    }

    // Filtra as estruturas que usam o produto
    const estruturasComProduto = estruturas.filter(estrutura => 
      estrutura.componentes?.some(comp => comp.componentId === selectedUsageProductId)
    );

    // Gera o HTML do relatório
    let html = `
      <div class="summary-box">
        <h3>Resumo do Produto</h3>
        <div class="usage-info">
          <strong>Código:</strong> ${produto.codigo}<br>
          <strong>Descrição:</strong> ${produto.descricao}<br>
          <strong>Tipo:</strong> ${produto.tipo}<br>
          <strong>Unidade:</strong> ${produto.unidade}
        </div>
        <div class="summary-info">
          <div class="summary-item">
            <div class="summary-value">${estruturasComProduto.length}</div>
            <div class="summary-label">Total de Utilizações</div>
          </div>
        </div>
      </div>
    `;

    if (estruturasComProduto.length === 0) {
      html += '<div class="no-results">Este produto não é utilizado em nenhuma estrutura.</div>';
    } else {
      html += `
        <div class="table-responsive">
          <table class="usage-table">
            <thead>
              <tr>
                <th>Código</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Quantidade</th>
                <th>Unidade</th>
              </tr>
            </thead>
            <tbody>
      `;

      estruturasComProduto.forEach(estrutura => {
        const produtoPai = produtos.find(p => p.id === estrutura.produtoPaiId);
        if (produtoPai) {
          const componente = estrutura.componentes.find(c => c.componentId === selectedUsageProductId);
          html += `
            <tr>
              <td>${produtoPai.codigo}</td>
              <td>${produtoPai.descricao}</td>
              <td>${produtoPai.tipo}</td>
              <td style="text-align: right">${componente.quantidade.toFixed(2)}</td>
              <td>${componente.unidade}</td>
            </tr>
          `;
        }
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
    }

    reportContent.innerHTML = html;
  } catch (error) {
    console.error("Erro ao gerar relatório:", error);
    reportContent.innerHTML = '<div class="error-message">Erro ao gerar relatório. Tente novamente.</div>';
  }
};

// Event listeners para o modal de uso
document.addEventListener('DOMContentLoaded', function() {
  const usageSearchInput = document.getElementById('usageSearchInput');
  let usageSearchTimeout = null;

  if (usageSearchInput) {
    usageSearchInput.addEventListener('input', (e) => {
      clearTimeout(usageSearchTimeout);
      usageSearchTimeout = setTimeout(() => searchUsageProducts(e.target.value), 300);
    });
  }

  document.addEventListener('click', (e) => {
    const usageSearchResults = document.getElementById('usageSearchResults');
    if (usageSearchResults && !usageSearchResults.contains(e.target) && e.target !== usageSearchInput) {
      usageSearchResults.style.display = 'none';
    }
  });
});
// ... existing code ...

window.displayUsageSearchResults = function(produtos) {
  const usageSearchResults = document.getElementById('usageSearchResults');
  usageSearchResults.innerHTML = '';

  if (produtos.length > 0) {
    produtos.forEach(produto => {
      const div = document.createElement('div');
      div.className = 'search-result-item';
      div.textContent = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
      div.onclick = () => selectUsageProduct(produto);
      usageSearchResults.appendChild(div);
    });
    usageSearchResults.style.display = 'block';
  } else {
    usageSearchResults.innerHTML = '<div class="search-result-item">Nenhum produto encontrado</div>';
  }
};

window.selectUsageProduct = function(produto) {
  selectedUsageProductId = produto.id;
  document.getElementById('usageSearchInput').value = `${produto.codigo} - ${produto.descricao}`;
  document.getElementById('usageSearchResults').style.display = 'none';
  generateUsageReport();
};

function showLoading(show = true) {
  const loadingDiv = document.getElementById('loadingDiv');
  if (!loadingDiv) {
    const div = document.createElement('div');
    div.id = 'loadingDiv';
    div.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    `;
    div.innerHTML = `
      <div style="
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      ">
        <div style="margin-bottom: 10px;">Carregando...</div>
        <div class="spinner"></div>
      </div>
    `;
    document.body.appendChild(div);
  }
  document.getElementById('loadingDiv').style.display = show ? 'flex' : 'none';
}

// Adiciona o estilo do spinner
const style = document.createElement('style');
style.textContent = `
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Adiciona botão de revisão ao lado do botão salvar
document.querySelector('.sap-buttons').innerHTML = `
  <div class="btn-group">
    <button class="btn-primary" onclick="openHistoryModal()">Histórico de Estruturas</button>
    <button class="btn-primary" onclick="openUsageModal()">Onde é Usado</button>
    <button class="btn-primary" onclick="openRevisionHistoryModal()">Histórico de Revisões</button>
  </div>
  <button class="btn-success" onclick="saveStructure()" disabled>Salvar Alterações</button>
  <button class="btn-primary" onclick="window.location.href='index.html'">Voltar</button>
  <button class="btn-danger" onclick="deleteCurrentStructure()">Excluir Estrutura</button>
`;

// Funções para controle de revisão
window.openRevisionModal = async function() {
  const estruturaAtual = getCurrentStructure();
  const folder = document.querySelector('.folder');

  if (!folder) {
    alert('Selecione um produto pai para criar uma estrutura.');
    return;
  }

  try {
    // Se já existe uma estrutura, abre o modal normalmente
    document.getElementById('revisionModal').style.display = 'block';
    const nextRevision = (estruturaAtual?.revisaoAtual || 0) + 1;
    document.getElementById('revisionNumber').value = `REV${String(nextRevision).padStart(3, '0')}`;
  } catch (error) {
    console.error("Erro ao abrir modal de revisão:", error);
    alert("Erro ao processar revisão: " + error.message);
  }
};

// Função para salvar uma nova estrutura sem revisão
window.saveNewStructure = async function() {
  const structureTree = document.getElementById('structureTree');
  const folders = structureTree.querySelectorAll('.folder');

  if (folders.length === 0) {
    alert("Selecione um produto pai para criar ou editar a estrutura!");
    return Promise.reject(new Error("Nenhum produto selecionado"));
  }

  const structureData = [];
  const processedIds = new Set();
  let hasDuplicates = false;
  let duplicateMessage = "Os seguintes componentes estão duplicados:\\n";

  function processFolder(folder) {
    const productId = folder.dataset.id;
    if (processedIds.has(productId)) {
      alert(`Ciclo detectado no produto ${productId}. A estrutura não pode conter ciclos.`);
      throw new Error("Ciclo detectado");
    }
    processedIds.add(productId);

    const components = [];
    const componentIds = new Set();
    folder.querySelectorAll('.component').forEach(comp => {
      const componentId = comp.dataset.id;
      const quantidade = parseFloat(comp.querySelector('.quantidade').value) || 1;
      if (quantidade > 0) {
        if (componentIds.has(componentId)) {
          hasDuplicates = true;
          const produto = produtos.find(p => p.id === componentId);
          duplicateMessage += `- ${produto.codigo} - ${produto.descricao} (${produto.tipo})\\n`;
        } else {
          componentIds.add(componentId);
          components.push({
            componentId: componentId,
            quantidade,
            unidade: produtos.find(p => p.id === componentId).unidade
          });
        }
      }
    });

    const operations = [];
    folder.querySelectorAll('.operation').forEach(op => {
      const sequencia = parseInt(op.querySelector('.sequence-input').value) || 1;
      const operacaoId = op.querySelector('.operacao').value;
      const recursoId = op.querySelector('.recurso').value;
      const tempo = parseFloat(op.querySelector('.tempo').value) || 1;
      const descricao = op.querySelector('.descricao').value;
      if (operacaoId && recursoId && tempo > 0) {
        operations.push({
          sequencia,
          operacaoId,
          recursoId,
          tempo,
          descricao: descricao || ''
        });
      }
    });

    const existingStructure = estruturas.find(e => e.produtoPaiId === productId);
    const now = new Date().toISOString();
    structureData.push({
      produtoPaiId: productId,
      componentes: components,
      operacoes: operations,
      dataCriacao: existingStructure?.dataCriacao || now,
      dataUltimaAlteracao: now,
      revisaoAtual: existingStructure ? (existingStructure.revisaoAtual || 0) : 0,
      usuarioUltimaAlteracao: {
        id: usuarioAtual.id,
        nome: usuarioAtual.nome,
        email: usuarioAtual.email
      }
    });
  }

  try {
    folders.forEach(folder => {
      processFolder(folder);
    });

    if (hasDuplicates) {
      duplicateMessage += "\\nPor favor, remova os itens duplicados antes de salvar.";
      alert(duplicateMessage);
      return Promise.reject(new Error("Componentes duplicados"));
    }

    for (const item of structureData) {
      const q = query(collection(db, "estruturas"), where("produtoPaiId", "==", item.produtoPaiId));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        // Estrutura existente - retorna sem salvar
        return { exists: true, data: item };
      } else {
        // Nova estrutura - salva com revisão 0
        const docRef = await addDoc(collection(db, "estruturas"), {
          ...item,
          revisaoAtual: 0
        });

        // Atualiza a lista de estruturas
        estruturas.push({ id: docRef.id, ...item, revisaoAtual: 0 });

        // Retorna indicando que é uma nova estrutura
        return { exists: false, data: { id: docRef.id, ...item, revisaoAtual: 0 } };
      }
    }
  } catch (error) {
    console.error("Erro ao salvar estrutura:", error);
    alert("Erro ao salvar estrutura: " + error.message);
    return Promise.reject(error);
  }
};

// Atualiza a função saveStructure para usar o modal de revisão
window.saveStructure = function() {
  if (hasChanges) {
    openRevisionModal();
  } else {
    alert('Não há alterações para salvar.');
  }
};

window.closeRevisionModal = function() {
  document.getElementById('revisionModal').style.display = 'none';
  document.getElementById('revisionReason').value = '';
  document.getElementById('revisionType').value = '';
  document.getElementById('revisionNotes').value = '';
};

window.openRevisionHistoryModal = async function() {
  const estruturaAtual = getCurrentStructure();
  if (!estruturaAtual) {
    alert('Selecione uma estrutura para ver o histórico de revisões.');
    return;
  }

  document.getElementById('revisionHistoryModal').style.display = 'block';
  showLoading(true);

  try {
    const revisoesRef = collection(db, "revisoes_estrutura");

    // First try without ordering to check if we have any revisions
    const basicQuery = query(
      revisoesRef,
      where("estruturaId", "==", estruturaAtual.id)
    );

    const snapshot = await getDocs(basicQuery);
    const tbody = document.getElementById('revisionHistoryTableBody');
    tbody.innerHTML = '';

    if (snapshot.empty) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma revisão encontrada</td></tr>';
      showLoading(false);
      return;
    }

    // Sort the results in memory if we can't use the index
    const revisoes = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Sort by dataRevisao in descending order
    revisoes.sort((a, b) => {
      const dateA = new Date(a.dataRevisao || 0);
      const dateB = new Date(b.dataRevisao || 0);
      return dateB - dateA;
    });

    revisoes.forEach(revisao => {
      const row = document.createElement('tr');
      const data = new Date(revisao.dataRevisao).toLocaleString('pt-BR');

      row.innerHTML = `
        <td>${revisao.numeroRevisao || 'N/A'}</td>
        <td>${data}</td>
        <td>${revisao.usuario?.nome || 'N/A'}</td>
        <td>${revisao.tipoAlteracao || 'N/A'}</td>
        <td>${revisao.motivo || 'N/A'}</td>
        <td>${revisao.observacoes || '-'}</td>
        <td>
          <button class="btn-primary" onclick="viewRevisionDetails('${revisao.id}')" style="padding: 4px 8px; font-size: 12px;">
            Ver Detalhes
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });

    showLoading(false);
  } catch (error) {
    console.error("Erro ao carregar histórico de revisões:", error);
    document.getElementById('revisionHistoryTableBody').innerHTML = 
      '<tr><td colspan="7" style="text-align: center; color: red;">Erro ao carregar histórico de revisões</td></tr>';
    showLoading(false);
  }
};

window.closeRevisionHistoryModal = function() {
  document.getElementById('revisionHistoryModal').style.display = 'none';
};

// ... existing code ...

function getCurrentStructure() {
  const folder = document.querySelector('.folder');
  if (!folder) return null;

  const productId = folder.dataset.id;
  return estruturas.find(e => e.produtoPaiId === productId);
}

// Atualiza a função saveStructure para usar o modal de revisão
window.saveStructure = function() {
  if (hasChanges) {
    openRevisionModal();
  } else {
    alert('Não há alterações para salvar.');
  }
};

window.viewRevisionDetails = async function(revisionId) {
  try {
    const revisaoRef = doc(db, "revisoes_estrutura", revisionId);
    const revisaoDoc = await getDoc(revisaoRef);

    if (!revisaoDoc.exists()) {
      alert('Revisão não encontrada.');
      return;
    }

    const revisao = revisaoDoc.data();
    const modal = document.getElementById('revisionDetailsModal');
    const content = document.getElementById('revisionDetailsContent');

    content.innerHTML = `
      <div class="summary-box">
        <h3>Detalhes da Revisão ${revisao.numeroRevisao}</h3>
        <div class="usage-info">
          <strong>Data:</strong> ${new Date(revisao.dataRevisao).toLocaleString('pt-BR')}<br>
          <strong>Usuário:</strong> ${revisao.usuario?.nome || 'N/A'}<br>
          <strong>Tipo de Alteração:</strong> ${revisao.tipoAlteracao || 'N/A'}<br>
          <strong>Motivo:</strong> ${revisao.motivo || 'N/A'}<br>
          <strong>Observações:</strong> ${revisao.observacoes || '-'}
        </div>
      </div>
    `;

    modal.style.display = 'block';
  } catch (error) {
    console.error("Erro ao carregar detalhes da revisão:", error);
    alert("Erro ao carregar detalhes da revisão");
  }
};

window.closeRevisionDetailsModal = function() {
  document.getElementById('revisionDetailsModal').style.display = 'none';
};

// Atualiza a função saveStructure para verificar se a estrutura existe
window.saveStructure = async function() {
  if (!hasChanges) {
    alert('Não há alterações para salvar.');
    return;
  }

  const estruturaAtual = getCurrentStructure();
  const folder = document.querySelector('.folder');

  if (!folder) {
    alert('Selecione um produto pai para criar uma estrutura.');
    return;
  }

  // Verifica se existem componentes ou operações
  const hasComponents = folder.querySelectorAll('.component').length > 0;
  const hasOperations = folder.querySelectorAll('.operation').length > 0;

  if (!hasComponents && !hasOperations) {
    alert('A estrutura deve conter pelo menos um componente ou uma operação para ser salva.');
    return;
  }

  try {
    const productId = folder.dataset.id;
    const q = query(collection(db, "estruturas"), where("produtoPaiId", "==", productId));
    const querySnapshot = await getDocs(q);

    // Se não existe estrutura, salva diretamente sem revisão
    if (querySnapshot.empty) {
      const structureData = [];
      const processedIds = new Set();
      let hasDuplicates = false;
      let duplicateMessage = "Os seguintes componentes estão duplicados:\\n";

      function processFolder(folder) {
        const productId = folder.dataset.id;
        if (processedIds.has(productId)) {
          alert(`Ciclo detectado no produto ${productId}. A estrutura não pode conter ciclos.`);
          throw new Error("Ciclo detectado");
        }
        processedIds.add(productId);

        const components = [];
        const componentIds = new Set();
        folder.querySelectorAll('.component').forEach(comp => {
          const componentId = comp.dataset.id;
          const quantidade = parseFloat(comp.querySelector('.quantidade').value) || 1;
          if (quantidade > 0) {
            if (componentIds.has(componentId)) {
              hasDuplicates = true;
              const produto = produtos.find(p => p.id === componentId);
              duplicateMessage += `- ${produto.codigo} - ${produto.descricao} (${produto.tipo})\\n`;
            } else {
              componentIds.add(componentId);
              components.push({
                componentId: componentId,
                quantidade,
                unidade: produtos.find(p => p.id === componentId).unidade
              });
            }
          }
        });

        const operations = [];
        folder.querySelectorAll('.operation').forEach(op => {
          const sequencia = parseInt(op.querySelector('.sequence-input').value) || 1;
          const operacaoId = op.querySelector('.operacao').value;
          const recursoId = op.querySelector('.recurso').value;
          const tempo = parseFloat(op.querySelector('.tempo').value) || 1;
          const descricao = op.querySelector('.descricao').value;
          if (operacaoId && recursoId && tempo > 0) {
            operations.push({
              sequencia,
              operacaoId,
              recursoId,
              tempo,
              descricao: descricao || ''
            });
          }
        });

        const now = new Date().toISOString();
        structureData.push({
          produtoPaiId: productId,
          componentes: components,
          operacoes: operations,
          dataCriacao: now,
          dataUltimaAlteracao: now,
          revisaoAtual: 0,
          usuarioUltimaAlteracao: {
            id: usuarioAtual.id,
            nome: usuarioAtual.nome,
            email: usuarioAtual.email
          }
        });
      }

      processFolder(folder);

      if (hasDuplicates) {
        duplicateMessage += "\\nPor favor, remova os itens duplicados antes de salvar.";
        alert(duplicateMessage);
        return;
      }

      // Salva a nova estrutura
      for (const item of structureData) {
        const docRef = await addDoc(collection(db, "estruturas"), item);
        estruturas.push({ id: docRef.id, ...item });
      }

      alert("Estrutura salva com sucesso!");
      await carregarDados();
      await loadStructureForProduct();
      return;
    }

    // Se já existe uma estrutura, abre o modal de revisão
    document.getElementById('revisionModal').style.display = 'block';
    const nextRevision = (estruturaAtual.revisaoAtual || 0) + 1;
    document.getElementById('revisionNumber').value = `REV${String(nextRevision).padStart(3, '0')}`;
  } catch (error) {
    console.error("Erro ao salvar estrutura:", error);
    alert("Erro ao salvar estrutura: " + error.message);
  }
};

// Adiciona a função saveRevision
window.saveRevision = async function() {
  const productId = document.getElementById('parentProductSelect').value;
  if (!productId) {
    alert('Por favor, selecione um produto pai antes de salvar a revisão.');
    return;
  }

  const estruturaAtual = getCurrentStructure();
  if (!estruturaAtual) {
    alert('Estrutura não encontrada.');
    return;
  }

  const revisionNumber = document.getElementById('revisionNumber').value;
  const revisionReason = document.getElementById('revisionReason').value.trim();
  const revisionType = document.getElementById('revisionType').value;
  const revisionNotes = document.getElementById('revisionNotes').value.trim();

  if (!revisionReason || !revisionType) {
    alert('Por favor, preencha todos os campos obrigatórios.');
    return;
  }

  try {
    const folder = document.querySelector('.folder');
    const productId = folder.dataset.id;

    // Coleta os dados atuais da estrutura
    const components = [];
    const componentIds = new Set();
    folder.querySelectorAll('.component').forEach(comp => {
      const componentId = comp.dataset.id;
      const quantidade = parseFloat(comp.querySelector('.quantidade').value) || 1;
      if (quantidade > 0) {
        if (componentIds.has(componentId)) {
          throw new Error("Componentes duplicados encontrados");
        }
        componentIds.add(componentId);
        components.push({
          componentId: componentId,
          quantidade,
          unidade: produtos.find(p => p.id === componentId).unidade
        });
      }
    });

    const operations = [];
    folder.querySelectorAll('.operation').forEach(op => {
      const sequencia = parseInt(op.querySelector('.sequence-input').value) || 1;
      const operacaoId = op.querySelector('.operacao').value;
      const recursoId = op.querySelector('.recurso').value;
      const tempo = parseFloat(op.querySelector('.tempo').value) || 1;
      const descricao = op.querySelector('.descricao').value;
      if (operacaoId && recursoId && tempo > 0) {
        operations.push({
          sequencia,
          operacaoId,
          recursoId,
          tempo,
          descricao: descricao || ''
        });
      }
    });

    const now = new Date().toISOString();

    // Atualiza a estrutura com a nova revisão
    const estruturaRef = doc(db, "estruturas", estruturaAtual.id);
    await updateDoc(estruturaRef, {
      componentes: components,
      operacoes: operations,
      dataUltimaAlteracao: now,
      revisaoAtual: estruturaAtual.revisaoAtual + 1,
      usuarioUltimaAlteracao: {
        id: usuarioAtual.id,
        nome: usuarioAtual.nome,
        email: usuarioAtual.email
      }
    });

    // Salva o histórico da revisão
    await addDoc(collection(db, "revisoes_estrutura"), {
      estruturaId: estruturaAtual.id,
      produtoPaiId: productId,
      numeroRevisao: revisionNumber,
      dataRevisao: now,
      tipoAlteracao: revisionType,
      motivo: revisionReason,
      observacoes: revisionNotes,
      componentes: components,
      operacoes: operations,
      usuario: {
        id: usuarioAtual.id,
        nome: usuarioAtual.nome,
        email: usuarioAtual.email
      }
    });

    alert("Revisão salva com sucesso!");
    closeRevisionModal();
    await carregarDados();
    await loadStructureForProduct();
  } catch (error) {
    console.error("Erro ao salvar revisão:", error);
    alert("Erro ao salvar revisão: " + error.message);
  }
};

// Função para atualizar apenas a lista de produtos
window.updateProductsList = async function() {
  try {
    // Guarda o ID do produto atualmente selecionado
    const currentProductId = document.getElementById('parentProductSelect').value;

    const produtosSnap = await getDocs(collection(db, "produtos"));
    produtos = produtosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    produtosPaisFiltrados = produtos.filter(p => p.tipo === 'PA' || p.tipo === 'SP');

    // Atualiza o select de produtos pai mantendo a seleção atual
    const parentSelect = document.getElementById('parentProductSelect');
    parentSelect.innerHTML = '<option value="">Selecione o produto pai...</option>';

    // Ordena os produtos por código
    const sortedProducts = [...produtosPaisFiltrados].sort((a, b) => 
      a.codigo.localeCompare(b.codigo)
    );

    sortedProducts.forEach(produto => {
      const option = document.createElement('option');
      option.value = produto.id;
      option.text = `${produto.codigo} - ${produto.descricao} (${produto.tipo})`;
      option.selected = produto.id === currentProductId;
      parentSelect.appendChild(option);
    });

    // Atualiza a lista de produtos disponíveis para a estrutura
    const searchTerm = document.getElementById('searchInput')?.value?.toUpperCase() || '';
    searchProducts();

    console.log("Lista de produtos atualizada com sucesso!");
  } catch (error) {
    console.error("Erro ao atualizar lista de produtos:", error);
    alert("Erro ao atualizar lista de produtos.");
  }
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
</script>
<!-- Modal de Estrutura do Produto -->
<div id="structureModal" class="modal">
<div class="modal-content" style="max-width: 800px; padding: 15px;">
  <span class="close-button" onclick="closeStructureModal()">×</span>
  <div class="sap-title">Estrutura e Processo</div>
  <div style="margin-top: 8px;">
    <div class="section-title" style="font-size: 13px; margin-bottom: 5px;">Componentes</div>
    <div class="components-list" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
    <button class="btn-primary" onclick="addComponentToModal()" style="margin-top: 5px;">Adicionar Componente</button>
  </div>
  <div style="margin-top: 8px;">
    <div class="section-title" style="font-size: 13px; margin-bottom: 5px;">Processo (Operações)</div>
    <div class="operations-list" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
    <button class="btn-primary" onclick="addOperationToModal()" style="margin-top: 5px;">Adicionar Operação</button>
  </div>
  <div class="sap-buttons" style="margin-top: 10px;">
    <button class="btn-success" onclick="saveStructureFromModal()">Salvar Alterações</button>
    <button class="btn-primary" onclick="closeStructureModal()">Fechar</button>
  </div>
</div>
</div>
<!-- Modal de Visualização do Desenho -->
<div id="drawingModal" class="modal">
  <div class="modal-content" style="max-width: 600px; padding: 15px;">
    <span class="close-button" onclick="closeDrawingModal()">×</span>
    <div class="sap-title" id="drawingModalTitle">Visualização do Desenho</div>
    <div id="drawingThumbnail" style="text-align: center; margin-top: 10px; max-height: 400px; overflow-y: auto;">
      <canvas id="drawingImage" style="max-width: 100%; border: 1px solid var(--border-color); border-radius: 4px;"></canvas>
    </div>
    <div class="sap-buttons" style="margin-top: 10px;">
      <button class="btn-primary" onclick="closeDrawingModal()">Fechar</button>
    </div>
  </div>
</div>

<!-- Adicionar o novo modal após o modal de histórico existente -->
<!-- Modal Onde é Usado -->
<div id="usageModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeUsageModal()">&times;</span>
    <div class="sap-title">Onde é Usado</div>
    <div class="search-container">
      <div class="search-group">
        <label class="search-label">Digite o código ou descrição do produto</label>
        <input 
          type="text" 
          id="usageSearchInput" 
          class="search-input" 
          placeholder="Digite para buscar..."
          autocomplete="off"
        >
        <div id="usageSearchResults" class="search-results" style="display: none;"></div>
      </div>
    </div>
    <div id="usageReportContent"></div>
  </div>
</div>

<!-- Modal de Revisão -->
<div id="revisionModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeRevisionModal()">&times;</span>
    <div class="sap-title">Nova Revisão da Estrutura</div>
    <div class="form-section">
      <div class="form-group">
        <label class="required">Número da Revisão</label>
        <input type="text" id="revisionNumber" readonly>
      </div>
      <div class="form-group">
        <label class="required">Motivo da Alteração</label>
        <textarea id="revisionReason" rows="3" maxlength="500" required placeholder="Descreva o motivo das alterações..."></textarea>
      </div>
      <div class="form-group">
        <label class="required">Tipo de Alteração</label>
        <select id="revisionType" required>
          <option value="">Selecione o tipo...</option>
          <option value="COMPONENTE">Alteração de Componentes</option>
          <option value="PROCESSO">Alteração de Processo</option>
          <option value="AMBOS">Alteração de Componentes e Processo</option>
        </select>
      </div>
      <div class="form-group">
        <label>Observações</label>
        <textarea id="revisionNotes" rows="2" maxlength="200" placeholder="Observações adicionais (opcional)..."></textarea>
      </div>
    </div>
    <div class="sap-buttons">
      <button class="btn-success" onclick="saveRevision()">Salvar Revisão</button>
      <button class="btn-danger" onclick="closeRevisionModal()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de Histórico de Revisões -->
<div id="revisionHistoryModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <span class="close" onclick="closeRevisionHistoryModal()">&times;</span>
    <div class="sap-title">Histórico de Revisões</div>
    <div id="revisionHistoryContent" style="max-height: 60vh; overflow-y: auto;">
      <table class="usage-table">
        <thead>
          <tr>
            <th>Revisão</th>
            <th>Data</th>
            <th>Usuário</th>
            <th>Tipo</th>
            <th>Motivo</th>
            <th>Observações</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="revisionHistoryTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal de Detalhes da Revisão -->
<div id="revisionDetailsModal" class="modal">
  <div class="modal-content" style="max-width: 600px;">
    <span class="close" onclick="closeRevisionDetailsModal()">&times;</span>
    <div class="sap-title">Detalhes da Revisão</div>
    <div id="revisionDetailsContent"></div>
    <div class="sap-buttons">
      <button class="btn-primary" onclick="closeRevisionDetailsModal()">Fechar</button>
    </div>
  </div>
</div>

</body>
</html>