<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cota√ß√µes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --primary-color: #0854a0;
      --primary-hover: #0a4d8c;
      --secondary-color: #f0f3f6;
      --border-color: #d4d4d4;
      --text-color: #333;
      --text-secondary: #666;
      --success-color: #107e3e;
      --success-hover: #0d6e36;
      --danger-color: #bb0000;
      --danger-hover: #a30000;
      --warning-color: #e9730c;
      --header-bg: #354a5f;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f7f7;
      color: var(--text-color);
    }

    .container {
      width: 95%;
      max-width: 1200px;
      margin: 30px auto;
      padding: 0;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header {
      background-color: var(--header-bg);
      color: white;
      padding: 15px 20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 500;
      margin: 0;
    }

    .quotations-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .quotations-table th,
    .quotations-table td {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      text-align: left;
    }

    .quotations-table th {
      background-color: var(--secondary-color);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .quotations-table tr:hover {
      background-color: #f8f9fa;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-aberta { background-color: #ffc107; color: #000; }
    .status-enviada { background-color: #17a2b8; color: #fff; }
    .status-respondida { background-color: #28a745; color: #fff; }
    .status-fechada { background-color: #6c757d; color: #fff; }
    .status-aprovada { background-color: #28a745; color: #fff; }
    .status-badge.status-cancelado { background-color: var(--danger-color); color: white; }
    .status-badge.status-rejeitada { 
    background-color: #d32f2f;
    color: white;
    border: 2px solid #b71c1c;
}

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 80%;
      max-width: 1000px;
      border-radius: 8px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .close-button {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      text-align: left;
    }

    .comparison-table th {
      background-color: var(--secondary-color);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .supplier-section {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .supplier-info {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .supplier-response {
      margin-top: 15px;
      padding: 15px;
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
    }

    .approval-section {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--secondary-color);
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .approval-level {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #fff;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background-color: var(--success-hover);
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background-color: var(--danger-hover);
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .access-denied {
      text-align: center;
      padding: 50px 20px;
      background-color: #f8d7da;
      color: #721c24;
      border-radius: 8px;
      margin: 50px auto;
      max-width: 600px;
      border: 1px solid #f5c6cb;
    }

    .supplier-list {
      margin: 10px 0;
      padding: 10px;
      background-color: var(--secondary-color);
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }

    .supplier-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .supplier-item:last-child {
      border-bottom: none;
    }

    .supplier-info {
      flex: 1;
    }

    .supplier-actions {
      display: flex;
      gap: 5px;
    }

    .copy-link-btn {
      background-color: #17a2b8;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .remove-supplier-btn {
      background-color: var(--danger-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .supplier-select {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }

    .response-link {
      font-size: 12px;
      color: var(--text-secondary);
      word-break: break-all;
    }

    .supplierTables {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .supplierTables table {
      width: 100%;
    }

    .item-selected {
      background-color: #e8f5e9;
    }

    .item-disabled {
      background-color: #f5f5f5;
      color: #999;
    }

    .item-disabled input[type="checkbox"] {
      pointer-events: none;
      opacity: 0.5;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center; /* Center the buttons */
    }

    .action-buttons button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .view-button {
      background-color: var(--primary-color);
      color: white;
    }

    .send-button {
      background-color: #17a2b8;
      color: white;
    }

    .approve-button {
      background-color: var(--success-color);
      color: white;
    }

    .required::after {
      content: "*";
      color: var(--danger-color);
      margin-left: 4px;
    }

    .sort-header {
      cursor: pointer;
    }

    .action-icon {
      padding: 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .view-icon {
      background-color: var(--primary-color);
      color: white;
    }

    .send-icon {
      background-color: #17a2b8;
      color: white;
    }

    .approve-icon {
      background-color: var(--success-color);
      color: white;
    }

    .response-indicators {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .response-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .response-dot.responded {
      background-color: var(--success-color);
    }

    .response-dot.pending {
      background-color: #ccc;
      border: 1px solid #999;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .fa-link {
      transition: transform 0.2s;
    }

    .fa-link:hover {
      transform: scale(1.2);
    }

  </style>
</head>
<body>
  <div id="mainContainer" class="container" style="display: none;">
    <div class="header">
      <h1>Cota√ß√µes</h1>
      <button onclick="window.location.href='index.html'" class="back-button">Voltar</button>
    </div>

    <table class="quotations-table">
      <thead>
        <tr>
          <th class="sort-header" onclick="sortTable('numero')">N√∫mero</th>
          <th class="sort-header" onclick="sortTable('data')">Data</th>
          <th class="sort-header" onclick="sortTable('solicitacao')">Solicita√ß√£o</th>
          <th class="sort-header" onclick="sortTable('fornecedores')">Fornecedores</th>
          <th>Respostas</th>
          <th class="sort-header" onclick="sortTable('valorTotal')">Valor Total</th>
          <th class="sort-header" onclick="sortTable('status')" style="width: 120px">Status</th>
          <th style="width: 180px; text-align: center;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="quotationsTableBody">
      </tbody>
    </table>
    <style>
      .quotations-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .quotations-table th,
      .quotations-table td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
      }
      .quotations-table th {
        background-color: #f8f9fa;
      }
      .quotations-table tr:hover {
        background-color: #f5f5f5;
      }
    </style>
  </div>

  <div id="accessDenied" class="access-denied" style="display: none;">
    <h2>Acesso Negado</h2>
    <p>Voc√™ n√£o possui permiss√£o para acessar esta funcionalidade.</p>
    <p>Entre em contato com o administrador do sistema para solicitar acesso.</p>
    <button onclick="window.location.href='index.html'" class="back-button">Voltar para o Menu</button>
  </div>

  <div id="quotationModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('quotationModal')">&times;</span>
      <h2>Detalhes da Cota√ß√£o</h2>

      <div class="supplier-section">
        <h3>Fornecedores</h3>
        <div id="principalSupplierInfo" style="margin-bottom: 10px;"></div>
        <div class="supplier-list" id="suppliersList"></div>

        <div class="form-group">
          <select id="supplierSelect" class="supplier-select">
            <option value="">Selecione o fornecedor...</option>
          </select>
          <button id="addSupplierBtn" onclick="addSupplier()">Adicionar Fornecedor</button>
        </div>
      </div>

      <div class="comparison-section">
        <h3>Comparativo de Pre√ßos por Fornecedor</h3>
        <div id="supplierTables"></div>
      </div>

      <div class="approval-section">
        <h3>Aprova√ß√µes Necess√°rias</h3>
        <div class="approval-level">
          <div>
            <strong>N√≠vel 1 (at√© R$ 1.000)</strong>
            <div>Supervisor de Compras</div>
          </div>
          <span class="status-badge status-pendente">Pendente</span>
        </div>
        <div class="approval-level">
          <div>
            <strong>N√≠vel 2 (at√© R$ 10.000)</strong>
            <div>Gerente de Compras</div>
          </div>
          <span class="status-badge status-pendente">Pendente</span>
        </div>
        <div class="approval-level">
          <div>
            <strong>N√≠vel 3 (acima de R$ 10.000)</strong>
            <div>Diretor</div>
          </div>
          <span class="status-badge status-pendente">Pendente</span>
        </div>
      </div>

      <div style="margin-top: 20px;">
        <button id="approveBtn" onclick="approveQuotation()" class="btn-success" style="display: none;">Aprovar Cota√ß√£o</button>
        <button id="generateOrderBtn" onclick="generatePurchaseOrder()" class="btn-primary" style="display: none;">Gerar Pedido</button>
        <button id="saveBtn" onclick="saveQuotation()" class="btn-primary">Salvar</button>
        <button id="editBtn" onclick="editQuotation()" class="btn-secondary">Editar</button>
        <button id="deleteBtn" onclick="deleteQuotation()" class="btn-danger">Excluir</button>
        <button id="rejectBtn" onclick="rejectQuotation()" class="btn-danger" style="display: none;">Recusar Cota√ß√£o</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { 
      collection, 
      addDoc, 
      getDocs,
      doc,
      getDoc,
      updateDoc,
      Timestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let fornecedores = [];
    let cotacoes = [];
    let solicitacoes = [];
    let currentQuotation = null;
    let currentUser = null;
    let userPermissions = [];
    let selectedItems = new Map();

    window.onload = async function() {
      const userSession = localStorage.getItem('currentUser');
      if (!userSession) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = JSON.parse(userSession);

      await checkUserPermissions();

      await loadInitialData();
      await loadQuotations();
    };

    async function checkUserPermissions() {
      try {
        if (currentUser.nivel === 9) {
          document.getElementById('mainContainer').style.display = 'block';
          return;
        }

        const permissionsDoc = await getDoc(doc(db, "permissoes", currentUser.id));

        if (permissionsDoc.exists()) {
          userPermissions = permissionsDoc.data().permissoes || [];

          if (userPermissions.includes('cotacoes')) {
            document.getElementById('mainContainer').style.display = 'block';
            return;
          }
        }

        document.getElementById('accessDenied').style.display = 'block';
      } catch (error) {
        console.error("Erro ao verificar permiss√µes:", error);
        alert("Erro ao verificar permiss√µes. Por favor, tente novamente.");
      }
    }

    async function loadInitialData() {
      try {
        const [fornecedoresSnap, cotacoesSnap, solicitacoesSnap] = await Promise.all([
          getDocs(collection(db, "fornecedores")),
          getDocs(collection(db, "cotacoes")),
          getDocs(collection(db, "solicitacoesCompra"))
        ]);

        fornecedores = fornecedoresSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        cotacoes = cotacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        solicitacoes = solicitacoesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        alert("Erro ao carregar dados iniciais.");
      }
    }

    async function loadQuotations() {
      const tableBody = document.getElementById('quotationsTableBody');
      tableBody.innerHTML = '';

      cotacoes
        .sort((a, b) => b.dataCriacao.seconds - a.dataCriacao.seconds)
        .forEach(cotacao => {
          const solicitacao = solicitacoes.find(s => s.id === cotacao.solicitacaoId);

          let fornecedorPrincipalNome = 'N/A';
          if (solicitacao && solicitacao.fornecedorId) {
            const fornecedorPrincipal = fornecedores.find(f => f.id === solicitacao.fornecedorId);
            if (fornecedorPrincipal) {
              fornecedorPrincipalNome = fornecedorPrincipal.razaoSocial;
            }
          }

          const fornecedoresConvidadosNomes = cotacao.fornecedores?.map(f => 
            fornecedores.find(forn => forn.id === f)?.razaoSocial
          ).filter(Boolean).join(', ') || 'Nenhum convidado';

          const fornecedoresColuna = `${fornecedorPrincipalNome} (convidados: ${fornecedoresConvidadosNomes})`;

          const row = document.createElement('tr');
          row.ondblclick = () => viewQuotation(cotacao.id);
          row.innerHTML = `
            <td>${cotacao.numero}</td>
            <td>${new Date(cotacao.dataCriacao.seconds * 1000).toLocaleDateString()}</td>
            <td>${solicitacao?.numero || 'N/A'}</td>
            <td>${fornecedoresColuna}</td>
            <td>
              <div class="response-indicators">
                ${(cotacao.fornecedores || []).map(fornecedorId => {
                  const hasResponse = cotacao.respostas?.[fornecedorId];
                  return `<span class="response-dot ${hasResponse ? 'responded' : 'pending'}" 
                         title="${hasResponse ? 'Respondido' : 'Aguardando'}"></span>`;
                }).join('')}
              </div>
            </td>
            <td>R$ ${cotacao.valorTotal?.toFixed(2) || '0,00'}</td>
            <td><span class="status-badge status-${cotacao.status.toLowerCase()}">${cotacao.status}</span></td>
            <td style="text-align: center;">
              <div class="action-buttons" style="display: inline-flex; gap: 5px; justify-content: center;">
                <button class="action-icon view-icon" title="Detalhes" onclick="viewQuotation('${cotacao.id}')">üëÅÔ∏è</button>
                ${cotacao.status === 'ABERTA' && (currentUser.nivel >= 2 || userPermissions.includes('enviar_cotacoes')) ? `
                  <button class="action-icon send-icon" title="Enviar" onclick="sendQuotation('${cotacao.id}')">üì§</button>
                ` : ''}
                ${cotacao.status === 'RESPONDIDA' && (currentUser.nivel >= 3 || userPermissions.includes('aprovar_cotacoes')) ? `
                  <button class="action-icon approve-icon" title="Aprovar" onclick="approveQuotation('${cotacao.id}')">‚úì</button>
                ` : ''}
              </div>
            </td>
          `;
          tableBody.appendChild(row);
        });
    }

    window.viewQuotation = async function(quotationId) {
      const cotacao = cotacoes.find(c => c.id === quotationId);
      if (!cotacao) return;

      currentQuotation = cotacao;
      selectedItems.clear();

      const modal = document.getElementById('quotationModal');
      modal.dataset.cotacaoId = quotationId;

      // Adicionar se√ß√£o de hist√≥rico de altera√ß√µes
      const historicoSection = document.createElement('div');
      historicoSection.className = 'history-section';
      historicoSection.style.cssText = 'margin-top: 20px; padding: 15px; background-color: var(--secondary-color); border-radius: 4px; border: 1px solid var(--border-color);';

      historicoSection.innerHTML = `
        <h3>Hist√≥rico de Altera√ß√µes</h3>
        <div class="history-list">
          ${(cotacao.alteracoes || []).map(alteracao => {
            let mensagem = '';
            switch (alteracao.tipo) {
              case 'adicao':
                mensagem = `Item adicionado: ${alteracao.item.codigo} - ${alteracao.item.descricao} (${alteracao.item.quantidade} ${alteracao.item.unidade})`;
                break;
              case 'remocao':
                mensagem = `Item removido: ${alteracao.item.codigo} - ${alteracao.item.descricao}`;
                break;
              case 'modificacao':
                mensagem = `Quantidade alterada para ${alteracao.itemNovo.codigo}: ${alteracao.itemAntigo.quantidade} ‚Üí ${alteracao.itemNovo.quantidade} ${alteracao.itemNovo.unidade}`;
                break;
            }
            return `
              <div class="history-item" style="margin: 10px 0; padding: 10px; background-color: white; border-radius: 4px; border: 1px solid var(--border-color);">
                <div style="color: #666; font-size: 0.9em;">
                  ${new Date(alteracao.data.seconds * 1000).toLocaleString()}
                </div>
                <div style="margin-top: 5px;">
                  ${mensagem}
                </div>
              </div>
            `;
          }).join('') || '<p>Nenhuma altera√ß√£o registrada.</p>'}
        </div>
      `;

      // Inserir a se√ß√£o de hist√≥rico antes dos bot√µes de a√ß√£o
      const actionButtons = modal.querySelector('.modal-content > div:last-child');
      modal.querySelector('.modal-content').insertBefore(historicoSection, actionButtons);

      updateSuppliersList(cotacao);
      await updateSupplierTables(cotacao);
      // Exibir o fornecedor principal vindo da solicita√ß√£o original
      const solicitacao = solicitacoes.find(s => s.id === cotacao.solicitacaoId);
      if (solicitacao && solicitacao.fornecedorId) {
        const fornecedorPrincipal = fornecedores.find(f => f.id === solicitacao.fornecedorId);
        const principalSupplierInfoDiv = document.getElementById('principalSupplierInfo');
        if (principalSupplierInfoDiv && fornecedorPrincipal) {
          principalSupplierInfoDiv.innerHTML = `
            <strong>Fornecedor Principal:</strong> ${fornecedorPrincipal.razaoSocial}<br>
            CNPJ: ${fornecedorPrincipal.cnpj || 'N/A'}
          `;
        } else if (principalSupplierInfoDiv) {
           principalSupplierInfoDiv.innerHTML = '<strong>Fornecedor Principal:</strong> N/A';
        }
      } else {
        const principalSupplierInfoDiv = document.getElementById('principalSupplierInfo');
        if (principalSupplierInfoDiv) {
          principalSupplierInfoDiv.innerHTML = '<strong>Fornecedor Principal:</strong> N/A';
        }
      }

      const canAddSupplier = currentUser.nivel >= 2 || userPermissions.includes('gerenciar_cotacoes');
      const canApprove = currentUser.nivel >= 3 || userPermissions.includes('aprovar_cotacoes');
      const canGenerateOrder = currentUser.nivel >= 3 || userPermissions.includes('gerar_pedidos');
      const canReject = currentUser.nivel >= 2 || userPermissions.includes('gerenciar_cotacoes');

      document.getElementById('addSupplierBtn').style.display = canAddSupplier ? 'inline-block' : 'none';
      document.getElementById('approveBtn').style.display = canApprove ? 'inline-block' : 'none';
      document.getElementById('generateOrderBtn').style.display = canGenerateOrder ? 'inline-block' : 'none';

      // Atualizar os bot√µes de a√ß√£o
      const actionButtonsDiv = modal.querySelector('.modal-content > div:last-child');
      actionButtonsDiv.innerHTML = `
        <button id="approveBtn" onclick="approveQuotation()" class="btn-success" style="display: ${canApprove ? 'inline-block' : 'none'}">Aprovar Cota√ß√£o</button>
        <button id="generateOrderBtn" onclick="generatePurchaseOrder()" class="btn-primary" style="display: ${canGenerateOrder ? 'inline-block' : 'none'}">Gerar Pedido</button>
        <button id="saveBtn" onclick="saveQuotation()" class="btn-primary">Salvar</button>
        <button id="editBtn" onclick="editQuotation()" class="btn-secondary">Editar</button>
        <button id="deleteBtn" onclick="deleteQuotation()" class="btn-danger">Excluir</button>
        <button id="rejectBtn" onclick="rejectQuotation()" class="btn-danger" style="display: ${canReject ? 'inline-block' : 'none'}">Recusar Cota√ß√£o</button>
      `;

      modal.style.display = 'block';
    };

    function updateSuppliersList(cotacao) {
      const suppliersList = document.getElementById('suppliersList');
      suppliersList.innerHTML = '';

      if (cotacao.fornecedores) {
        cotacao.fornecedores.forEach(fornecedorId => {
          const fornecedor = fornecedores.find(f => f.id === fornecedorId);
          if (fornecedor) {
            const div = document.createElement('div');
            div.className = 'supplier-item';

            const responseLink = generateResponseLink(cotacao.id, fornecedorId);
            const resposta = cotacao.respostas?.[fornecedorId];

            div.innerHTML = `
              <div class="supplier-info">
                <strong>${fornecedor.razaoSocial}</strong>
                <div>CNPJ: ${fornecedor.cnpj || 'N/A'}</div>
                <div>Email: ${fornecedor.email || 'N/A'}</div>
                <div>Telefone: ${fornecedor.telefone || 'N/A'}</div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <i class="fas fa-link" style="color: #17a2b8; cursor: pointer;" 
                     onclick="copyResponseLink('${responseLink}')" 
                     title="Copiar link de resposta"></i>
                  <span style="font-size: 12px; color: #666;">Link de resposta</span>
                </div>
                ${resposta ? `
                  <div style="color: #28a745;">
                    <strong>Resposta recebida em:</strong> 
                    ${new Date(resposta.dataResposta.seconds * 1000).toLocaleString()}
                    ${resposta.condicaoPagamento ? `<br>Condi√ß√£o de Pagamento: ${resposta.condicaoPagamento}` : ''}
                    ${resposta.prazoEntrega ? `<br>Prazo de Entrega: ${resposta.prazoEntrega}` : ''}
                  </div>
                ` : '<div style="color: #dc3545;">Aguardando resposta</div>'}
              </div>
              <div class="supplier-actions">
                <button class="remove-supplier-btn" onclick="removeSupplier('${cotacao.id}', '${fornecedorId}')">
                  Remover
                </button>
              </div>
            `;
            suppliersList.appendChild(div);
          }
        });
      }

      const supplierSelect = document.getElementById('supplierSelect');
      supplierSelect.innerHTML = '<option value="">Selecione o fornecedor...</option>';

      fornecedores
        .filter(f => !cotacao.fornecedores?.includes(f.id))
        .forEach(fornecedor => {
          supplierSelect.innerHTML += `
            <option value="${fornecedor.id}">
              ${fornecedor.codigo} - ${fornecedor.razaoSocial}
            </option>`;
        });
    }

    async function updateSupplierTables(cotacao) {
      const supplierTables = document.getElementById('supplierTables');
      supplierTables.innerHTML = '';

      // Buscar v√≠nculos produto-fornecedor
      const vinculosSnap = await getDocs(collection(db, "produtos_fornecedores"));
      const vinculos = vinculosSnap.docs.map(doc => doc.data());

      if (!cotacao.fornecedores || cotacao.fornecedores.length === 0) {
        supplierTables.innerHTML = '<p>Nenhum fornecedor adicionado.</p>';
        return;
      }

      cotacao.fornecedores.forEach(fornecedorId => {
        const fornecedor = fornecedores.find(f => f.id === fornecedorId);
        if (!fornecedor) return;

        const resposta = cotacao.respostas?.[fornecedorId];
        const table = document.createElement('table');
        table.className = 'comparison-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th colspan="6">${fornecedor.razaoSocial}</th>
            </tr>
            <tr>
              <th>Selecionar</th>
              <th>Item</th>
              <th>Quantidade</th>
              <th>Unidade</th>
              <th>Pre√ßo Unit√°rio</th>
              <th>Pre√ßo Total</th>
            </tr>
          </thead>
          <tbody>
            ${cotacao.itens.map((item, index) => {
              const preco = resposta?.precos?.[index] || 0;
              const precoTotal = preco * item.quantidade;
              const isSelected = selectedItems.get(index) === fornecedorId;
              const isDisabled = selectedItems.has(index) && !isSelected;
              const rowClass = isSelected ? 'item-selected' : (isDisabled ? 'item-disabled' : '');

              return `
                <tr class="${rowClass}" data-item-index="${index}">
                  <td>
                    <input type="checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           ${isDisabled ? 'disabled' : ''} 
                           data-fornecedor="${fornecedorId}" 
                           data-item="${index}" 
                           onchange="handleItemSelection(this)">
                  </td>
                  <td>${item.codigo} - ${item.descricao}</td>
                  <td>${item.quantidade}</td>
                  <td>${item.unidade}</td>
                  <td>R$ ${preco.toFixed(2)}</td>
                  <td>R$ ${precoTotal.toFixed(2)}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5"><strong>Total Selecionado</strong></td>
              <td id="total-${fornecedorId}">R$ 0,00</td>
            </tr>
          </tfoot>
        `;

        supplierTables.appendChild(table);
      });

      // Update totals based on previously selected items
      updateAllTotals();
    }

    window.handleItemSelection = function(checkbox) {
      const itemIndex = parseInt(checkbox.dataset.item);
      const fornecedorId = checkbox.dataset.fornecedor;

      if (checkbox.checked) {
        // If another supplier was selected for this item, uncheck it
        if (selectedItems.has(itemIndex)) {
          const previousFornecedorId = selectedItems.get(itemIndex);
          const previousCheckbox = document.querySelector(`input[type="checkbox"][data-fornecedor="${previousFornecedorId}"][data-item="${itemIndex}"]`);
          if (previousCheckbox) {
            previousCheckbox.checked = false;
          }
        }
        selectedItems.set(itemIndex, fornecedorId);
      } else {
        selectedItems.delete(itemIndex);
      }

      // Update the UI to reflect the changes
      updateSupplierTables(currentQuotation);
    };

    function updateAllTotals() {
      currentQuotation.fornecedores.forEach(fornecedorId => {
        const resposta = currentQuotation.respostas?.[fornecedorId];
        if (!resposta) return;

        let total = 0;
        selectedItems.forEach((selectedFornecedorId, itemIndex) => {
          if (selectedFornecedorId === fornecedorId) {
            const preco = resposta.precos[itemIndex] || 0;
            const quantidade = currentQuotation.itens[itemIndex].quantidade;
            total += preco * quantidade;
          }
        });

        const totalElement = document.getElementById(`total-${fornecedorId}`);
        if (totalElement) {
          totalElement.textContent = `R$ ${total.toFixed(2)}`;
        }
      });
    }

    window.generateResponseLink = function(cotacaoId, fornecedorId) {
      const baseUrl = window.location.origin;
      const link = `${baseUrl}/resposta_cotacao.html?cotacao=${cotacaoId}&fornecedor=${fornecedorId}`;

      // Adicionar timestamp para evitar cache
      const timestamp = new Date().getTime();
      return `${link}&t=${timestamp}`;
    };

    window.copyResponseLink = function(link) {
      navigator.clipboard.writeText(link).then(() => {
        // Criar e mostrar um toast de sucesso
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background-color: #28a745;
          color: white;
          padding: 10px 20px;
          border-radius: 4px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          z-index: 1000;
          animation: fadeInOut 2s ease-in-out;
        `;
        toast.textContent = 'Link copiado para a √°rea de transfer√™ncia!';
        document.body.appendChild(toast);

        // Remover o toast ap√≥s 2 segundos
        setTimeout(() => {
          toast.remove();
        }, 2000);
      }).catch(err => {
        console.error('Erro ao copiar link:', err);
        alert('Erro ao copiar link. Por favor, copie manualmente.');
      });
    };

    window.removeSupplier = async function(cotacaoId, fornecedorId) {
      if (!confirm('Tem certeza que deseja remover este fornecedor da cota√ß√£o?')) {
        return;
      }

      try {
        const cotacao = cotacoes.find(c => c.id === cotacaoId);
        if (!cotacao) return;

        const fornecedores = cotacao.fornecedores.filter(f => f !== fornecedorId);

        await updateDoc(doc(db, "cotacoes", cotacaoId), {
          fornecedores: fornecedores
        });

        if (cotacao.respostas?.[fornecedorId]) {
          const respostas = { ...cotacao.respostas };
          delete respostas[fornecedorId];
          await updateDoc(doc(db, "cotacoes", cotacaoId), { respostas });
        }

        // Remove any selections for this supplier
        selectedItems.forEach((selectedFornecedorId, itemIndex) => {
          if (selectedFornecedorId === fornecedorId) {
            selectedItems.delete(itemIndex);
          }
        });

        await loadInitialData();
        updateSuppliersList(cotacao);
        updateSupplierTables(cotacao);
        alert('Fornecedor removido com sucesso!');
      } catch (error) {
        console.error("Erro ao remover fornecedor:", error);
        alert("Erro ao remover fornecedor.");
      }
    };

    window.addSupplier = async function() {
      if (currentUser.nivel < 2 && !userPermissions.includes('gerenciar_cotacoes')) {
        alert('Voc√™ n√£o tem permiss√£o para adicionar fornecedores √† cota√ß√£o.');
        return;
      }

      const cotacaoId = document.querySelector('#quotationModal').dataset.cotacaoId;
      const cotacao = cotacoes.find(c => c.id === cotacaoId);
      if (!cotacao) return;

      try {
        // Buscar par√¢metros do sistema
        const parametrosDoc = await getDoc(doc(db, "parametros", "sistema"));
        const parametros = parametrosDoc.exists() ? parametrosDoc.data() : {};
        const homologacaoObrigatoria = parametros.configuracaoSistema?.homologacaoFornecedor || false;

        // Buscar v√≠nculos produto-fornecedor
        const vinculosSnap = await getDocs(collection(db, "produtos_fornecedores"));
        const vinculos = vinculosSnap.docs.map(doc => doc.data());

        // Filtrar fornecedores
        const fornecedoresValidos = fornecedores.filter(f => {
          // Verificar se o fornecedor j√° est√° na cota√ß√£o
          if (cotacao.fornecedores?.includes(f.id)) {
            return false;
          }

          // Verificar se o fornecedor est√° ativo
          if (!f.ativo) {
            return false;
          }

          // Se a homologa√ß√£o for obrigat√≥ria, verificar o status
          if (homologacaoObrigatoria) {
            if (!f.statusHomologacao) return false;
            return ['Homologado', 'Em An√°lise'].includes(f.statusHomologacao);
          }

          // Se a homologa√ß√£o n√£o for obrigat√≥ria, aceitar todos os fornecedores ativos
          return true;
        });

        if (fornecedoresValidos.length === 0) {
          const mensagem = homologacaoObrigatoria 
            ? 'N√£o h√° fornecedores homologados e ativos dispon√≠veis para adicionar √† cota√ß√£o.'
            : 'N√£o h√° fornecedores ativos dispon√≠veis para adicionar √† cota√ß√£o.';
          alert(mensagem);
          return;
        }

        const select = document.createElement('select');
        select.innerHTML = '<option value="">Selecione o fornecedor...</option>';

        fornecedoresValidos.forEach(fornecedor => {
          // Contar produtos vinculados
          const produtosVinculados = cotacao.itens.filter(item =>
            vinculos.some(v => v.produtoId === item.produtoId && v.fornecedorId === fornecedor.id)
          ).length;

          // Adicionar informa√ß√µes de status e produtos vinculados
          const statusInfo = fornecedor.statusHomologacao ? ` - ${fornecedor.statusHomologacao}` : '';
          const produtosInfo = produtosVinculados > 0 ? ` (${produtosVinculados} produtos vinculados)` : '';

          select.innerHTML += `
            <option value="${fornecedor.id}">
              ${fornecedor.razaoSocial}${statusInfo}${produtosInfo}
            </option>
          `;
        });

        const dialog = document.createElement('div');
        dialog.className = 'modal';
        dialog.innerHTML = `
          <div class="modal-content" style="width: 400px;">
            <h3>Adicionar Fornecedor</h3>
            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
              <p style="margin: 0; font-size: 0.9em; color: #666;">
                <strong>Crit√©rios para adicionar fornecedor:</strong><br>
                - Fornecedor deve estar ativo<br>
                ${homologacaoObrigatoria ? '- Fornecedor deve estar homologado ou em an√°lise' : ''}
              </p>
            </div>
            ${select.outerHTML}
            <div style="margin-top: 20px;">
              <button onclick="confirmAddSupplier(this.closest('.modal'))">Adicionar</button>
              <button onclick="this.closest('.modal').remove()">Cancelar</button>
            </div>
          </div>
        `;

        document.body.appendChild(dialog);
        dialog.style.display = 'block';
      } catch (error) {
        console.error("Erro ao adicionar fornecedor:", error);
        alert("Erro ao adicionar fornecedor.");
      }
    };

    window.confirmAddSupplier = async function(dialog) {
      const select = dialog.querySelector('select');
      const fornecedorId = select.value;

      if (!fornecedorId) {
        alert('Selecione um fornecedor.');
        return;
      }

      try {
        const cotacaoId = document.querySelector('#quotationModal').dataset.cotacaoId;
        const cotacao = cotacoes.find(c => c.id === cotacaoId);

        if (!cotacao) return;

        const fornecedores = new Set(cotacao.fornecedores || []);
        fornecedores.add(fornecedorId);

        // Atualizar a cota√ß√£o com o novo fornecedor
        await updateDoc(doc(db, "cotacoes", cotacaoId), {
          fornecedores: Array.from(fornecedores),
          status: 'ABERTA' // Garantir que a cota√ß√£o volte para aberta quando adicionar fornecedor
        });

        // Gerar link de resposta para o novo fornecedor
        const responseLink = generateResponseLink(cotacaoId, fornecedorId);

        // Atualizar a interface
        await loadInitialData();
        viewQuotation(cotacaoId);
        dialog.remove();

        // Mostrar o link gerado
        alert(`Fornecedor adicionado com sucesso!\nLink de resposta: ${responseLink}`);
      } catch (error) {
        console.error("Erro ao adicionar fornecedor:", error);
        alert("Erro ao adicionar fornecedor.");
      }
    };

    window.closeModal = function(modalId) {
      document.getElementById(modalId).style.display = 'none';
    };

    window.sendQuotation = async function(quotationId) {
      if (currentUser.nivel < 2 && !userPermissions.includes('enviar_cotacoes')) {
        showToast('Voc√™ n√£o tem permiss√£o para enviar cota√ß√µes', 'error');
        return;
      }

      const cotacao = cotacoes.find(c => c.id === quotationId);
      if (!cotacao) return;

      // Verificar se h√° fornecedores
      if (!cotacao.fornecedores || cotacao.fornecedores.length === 0) {
        showToast('Adicione pelo menos um fornecedor antes de enviar a cota√ß√£o', 'error');
        return;
      }

      // Verificar se h√° itens
      if (!cotacao.itens || cotacao.itens.length === 0) {
        showToast('A cota√ß√£o n√£o possui itens para enviar', 'error');
        return;
      }

      // Criar modal de confirma√ß√£o
      const confirmModal = document.createElement('div');
      confirmModal.className = 'modal';

      // Preparar lista de fornecedores
      const fornecedoresList = cotacao.fornecedores.map(fornecedorId => {
        const fornecedor = fornecedores.find(f => f.id === fornecedorId);
        return fornecedor ? fornecedor.razaoSocial : 'Fornecedor n√£o encontrado';
      }).join('\n');

      // Preparar lista de itens
      const itensList = cotacao.itens.map(item => 
        `${item.codigo} - ${item.descricao} (${item.quantidade} ${item.unidade})`
      ).join('\n');

      // Preparar pr√©via do email para o primeiro fornecedor
      const primeiroFornecedor = fornecedores.find(f => f.id === cotacao.fornecedores[0]);
      const responseLink = primeiroFornecedor ? generateResponseLink(cotacao.id, primeiroFornecedor.id) : '';

      const emailPreview = primeiroFornecedor ? `
        <div style="margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #ddd;">
          <h4>Pr√©via do Email (${primeiroFornecedor.razaoSocial})</h4>
          <div style="background-color: white; padding: 15px; border-radius: 4px; margin-top: 10px; font-family: Arial, sans-serif;">
            <h2 style="color: #0854a0;">Cota√ß√£o ${cotacao.numero}</h2>
            <p>Prezado(a) ${primeiroFornecedor.razaoSocial},</p>
            <p>Voc√™ recebeu uma nova cota√ß√£o para an√°lise.</p>

            <h3 style="color: #0854a0;">Detalhes da Cota√ß√£o:</h3>
            <ul style="list-style-type: none; padding-left: 0;">
              ${cotacao.itens.map(item => `
                <li style="margin-bottom: 8px;">
                  <strong>${item.codigo}</strong> - ${item.descricao}<br>
                  <span style="color: #666;">Quantidade: ${item.quantidade} ${item.unidade}</span>
                </li>
              `).join('')}
            </ul>

            <p style="margin-top: 20px;">
              <strong>Para responder esta cota√ß√£o, acesse o link abaixo:</strong><br>
              <a href="${responseLink}" style="color: #0854a0; word-break: break-all;">${responseLink}</a>
            </p>

            ${cotacao.observacoes ? `
              <p style="margin-top: 20px;">
                <strong>Observa√ß√µes:</strong><br>
                ${cotacao.observacoes}
              </p>
            ` : ''}

            <p style="margin-top: 20px;">
              <strong>Importante:</strong><br>
              Este link √© exclusivo para sua empresa e n√£o deve ser compartilhado.
            </p>

            <p style="margin-top: 20px;">
              Atenciosamente,<br>
              Equipe de Compras
            </p>
          </div>
        </div>
      ` : '';

      confirmModal.innerHTML = `
        <div class="modal-content" style="width: 800px; max-height: 90vh; overflow-y: auto;">
          <h3>Confirmar Envio da Cota√ß√£o</h3>
          <div style="margin: 20px 0;">
            <p><strong>N√∫mero da Cota√ß√£o:</strong> ${cotacao.numero}</p>
            <p><strong>Data de Cria√ß√£o:</strong> ${new Date(cotacao.dataCriacao.seconds * 1000).toLocaleString()}</p>
          </div>

          <div style="margin: 20px 0;">
            <h4>Fornecedores que receber√£o a cota√ß√£o:</h4>
            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
              ${cotacao.fornecedores.map(fornecedorId => {
                const fornecedor = fornecedores.find(f => f.id === fornecedorId);
                return fornecedor ? `
                  <div style="margin-bottom: 5px;">
                    <strong>${fornecedor.razaoSocial}</strong>
                    <div style="font-size: 0.9em; color: #666;">
                      Email: ${fornecedor.email || 'N/A'}<br>
                      Telefone: ${fornecedor.telefone || 'N/A'}
                    </div>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>

          <div style="margin: 20px 0;">
            <h4>Itens da Cota√ß√£o:</h4>
            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
              ${cotacao.itens.map(item => `
                <div style="margin-bottom: 5px;">
                  <strong>${item.codigo} - ${item.descricao}</strong>
                  <div style="font-size: 0.9em; color: #666;">
                    Quantidade: ${item.quantidade} ${item.unidade}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          ${emailPreview}

          <div style="margin: 20px 0;">
            <label>
              <input type="checkbox" id="confirmSend" style="margin-right: 5px;">
              Confirmo que todos os dados est√£o corretos e desejo enviar a cota√ß√£o
            </label>
          </div>

          <div style="margin-top: 20px;">
            <button class="btn-primary" onclick="confirmSendQuotation('${quotationId}', this.closest('.modal'))" 
                    id="sendButton" disabled>
              Enviar Cota√ß√£o
            </button>
            <button onclick="this.closest('.modal').remove()">Cancelar</button>
          </div>
        </div>
      `;

      document.body.appendChild(confirmModal);
      confirmModal.style.display = 'block';

      // Habilitar/desabilitar bot√£o de envio baseado no checkbox
      confirmModal.querySelector('#confirmSend').addEventListener('change', function() {
        confirmModal.querySelector('#sendButton').disabled = !this.checked;
      });
    };

    window.confirmSendQuotation = async function(quotationId, dialog) {
      try {
        const cotacao = cotacoes.find(c => c.id === quotationId);
        if (!cotacao) return;

        // Mostrar indicador de carregamento
        const loadingToast = showToast('Enviando cota√ß√£o...', 'info', true);

        // Atualizar status da cota√ß√£o
        await updateDoc(doc(db, "cotacoes", quotationId), {
          status: 'ENVIADA',
          dataEnvio: Timestamp.now(),
          enviadoPor: currentUser.nome
        });

        // Buscar dados do solicitante
        const solicitacao = solicitacoes.find(s => s.id === cotacao.solicitacaoId);
        const solicitanteId = solicitacao?.solicitanteId;

        // Processar cada fornecedor individualmente
        for (const fornecedorId of cotacao.fornecedores) {
          try {
            const fornecedor = fornecedores.find(f => f.id === fornecedorId);
            if (!fornecedor || !fornecedor.email) {
              console.warn(`Fornecedor ${fornecedorId} n√£o encontrado ou sem email`);
              continue;
            }

            // Gerar link √∫nico para este fornecedor
            const responseLink = generateResponseLink(cotacao.id, fornecedorId);

            // Preparar o corpo do email espec√≠fico para este fornecedor
            const emailBody = `
              <h2>Cota√ß√£o ${cotacao.numero}</h2>
              <p>Prezado(a) ${fornecedor.razaoSocial},</p>
              <p>Voc√™ recebeu uma nova cota√ß√£o para an√°lise.</p>

              <h3>Detalhes da Cota√ß√£o:</h3>
              <ul>
                ${cotacao.itens.map(item => `
                  <li>${item.codigo} - ${item.descricao} (${item.quantidade} ${item.unidade})</li>
                `).join('')}
              </ul>

              <p>Para responder esta cota√ß√£o, acesse o link abaixo:</p>
              <p><a href="${responseLink}">${responseLink}</a></p>

              <p><strong>Importante:</strong><br>
              Este link √© exclusivo para sua empresa e n√£o deve ser compartilhado.</p>

              ${cotacao.observacoes ? `
                <p>Observa√ß√µes: ${cotacao.observacoes}</p>
              ` : ''}

              <p>Atenciosamente,<br>Equipe de Compras</p>
            `;

            // Criar documento de email espec√≠fico para este fornecedor
            const emailDoc = {
              to: fornecedor.email,
              subject: `Cota√ß√£o ${cotacao.numero} - ${fornecedor.razaoSocial}`,
              body: emailBody,
              status: 'PENDENTE',
              dataCriacao: Timestamp.now(),
              cotacaoId: cotacao.id,
              fornecedorId: fornecedor.id,
              fornecedorNome: fornecedor.razaoSocial
            };

            // Salvar o email na cole√ß√£o
            const emailRef = await addDoc(collection(db, "emails"), emailDoc);

            // Registrar tentativa de envio espec√≠fica para este fornecedor
            await addDoc(collection(db, "log_envios"), {
              cotacaoId: cotacao.id,
              fornecedorId: fornecedor.id,
              fornecedorEmail: fornecedor.email,
              fornecedorNome: fornecedor.razaoSocial,
              dataEnvio: Timestamp.now(),
              status: 'ENVIADO',
              tipo: 'EMAIL',
              emailId: emailRef.id
            });

            // Atualizar o toast com o progresso
            loadingToast.textContent = `Enviando cota√ß√£o para ${fornecedor.razaoSocial}...`;

          } catch (error) {
            console.error(`Erro ao processar fornecedor ${fornecedorId}:`, error);
            // Continuar com o pr√≥ximo fornecedor mesmo se houver erro
            continue;
          }
        }

        // Criar notifica√ß√£o para o solicitante
        if (solicitanteId) {
          const notificacao = {
            tipo: 'cotacao_enviada',
            cotacaoId: cotacao.id,
            cotacaoNumero: cotacao.numero,
            mensagem: `A cota√ß√£o ${cotacao.numero} foi enviada para ${cotacao.fornecedores.length} fornecedor(es).`,
            data: Timestamp.now(),
            lida: false,
            destinatarioId: solicitanteId,
            remetenteId: currentUser.id,
            remetenteNome: currentUser.nome
          };

          await addDoc(collection(db, "notificacoes"), notificacao);
        }

        // Registrar log de envio geral
        await addDoc(collection(db, "log_cotacoes"), {
          cotacaoId: cotacao.id,
          cotacaoNumero: cotacao.numero,
          acao: 'ENVIO',
          data: Timestamp.now(),
          usuarioId: currentUser.id,
          usuarioNome: currentUser.nome,
          detalhes: {
            fornecedores: cotacao.fornecedores.length,
            itens: cotacao.itens.length
          }
        });

        dialog.remove();
        showToast('Cota√ß√£o enviada com sucesso!', 'success');

        // Recarregar dados
        await loadInitialData();
        await loadQuotations();
      } catch (error) {
        console.error("Erro ao enviar cota√ß√£o:", error);
        showToast('Erro ao enviar cota√ß√£o', 'error');
      }
    };

    window.approveQuotation = async function(quotationId) {
      if (currentUser.nivel < 3 && !userPermissions.includes('aprovar_cotacoes')) {
        alert('Voc√™ n√£o tem permiss√£o para aprovar cota√ß√µes.');
        return;
      }

      const cotacao = cotacoes.find(c => c.id === quotationId);
      if (!cotacao) return;

      let bestTotal = Infinity;
      let bestFornecedor = null;

      cotacao.fornecedores.forEach(fornecedorId => {
        const resposta = cotacao.respostas?.[fornecedorId];
        if (resposta?.precos) {
          const total = resposta.precos.reduce((sum, preco, idx) => 
            sum + (preco * cotacao.itens[idx].quantidade), 0);

          if (total > 0 && total < bestTotal) {
            bestTotal = total;
            bestFornecedor = fornecedorId;
          }
        }
      });

      if (!bestFornecedor) {
        alert('N√£o foi poss√≠vel determinar o melhor fornecedor.');
        return;
      }

      if (confirm(`Confirma a aprova√ß√£o da cota√ß√£o para o fornecedor selecionado?\nValor Total: R$ ${bestTotal.toFixed(2)}`)) {
        try {
          await updateDoc(doc(db, "cotacoes", quotationId), {
            status: 'APROVADA',
            fornecedorAprovado: bestFornecedor,
            valorAprovado: bestTotal,
            dataAprovacao: Timestamp.now(),
            aprovadoPor: currentUser.nome
          });

          await loadInitialData();
          await loadQuotations();
          alert('Cota√ß√£o aprovada com sucesso!');
        } catch (error) {
          console.error("Erro ao aprovar cota√ß√£o:", error);
          alert("Erro ao aprovar cota√ß√£o.");
        }
      }
    };

    window.generatePurchaseOrder = async function() {
      if (currentUser.nivel < 3 && !userPermissions.includes('gerar_pedidos')) {
        alert('Voc√™ n√£o tem permiss√£o para gerar pedidos de compra.');
        return;
      }

      if (selectedItems.size === 0) {
        alert('Selecione pelo menos um item para gerar o pedido.');
        return;
      }

      try {
        // Group items by supplier
        const itemsBySupplier = new Map();
        selectedItems.forEach((fornecedorId, itemIndex) => {
          if (!itemsBySupplier.has(fornecedorId)) {
            itemsBySupplier.set(fornecedorId, []);
          }
          itemsBySupplier.get(fornecedorId).push(itemIndex);
        });

        // Create purchase orders for each supplier
        for (const [fornecedorId, itemIndices] of itemsBySupplier) {
          const fornecedor = fornecedores.find(f => f.id === fornecedorId);
          const resposta = currentQuotation.respostas[fornecedorId];

          const itensSelecionados = itemIndices.map(itemIndex => {
            const item = currentQuotation.itens[itemIndex];
            return {
              ...item,
              valorUnitario: resposta.precos[itemIndex],
              valorTotal: resposta.precos[itemIndex] * item.quantidade
            };
          });

          const totalPedido = itensSelecionados.reduce((sum, item) => sum + item.valorTotal, 0);

          const numeroSequencial = (await getDocs(collection(db, "pedidosCompra"))).size + 1;
          const numeroPedido = numeroSequencial.toString().padStart(6, '0');

          const pedido = {
            numero: numeroPedido,
            cotacaoId: currentQuotation.id,
            fornecedorId: fornecedorId,
            itens: itensSelecionados,
            valorTotal: totalPedido,
            condicaoPagamento: resposta.condicaoPagamento,
            prazoEntrega: resposta.prazoEntrega,
            status: 'ABERTO',
            dataCriacao: Timestamp.now(),
            criadoPor: currentUser.nome
          };

          await addDoc(collection(db, "pedidosCompra"), pedido);
        }

        // Update quotation status
        await updateDoc(doc(db, "cotacoes", currentQuotation.id), {
          status: 'FECHADA'
        });

        alert('Pedidos de compra gerados com sucesso!');
        await loadInitialData();
        await loadQuotations();
        closeModal('quotationModal');
      } catch (error) {
        console.error("Erro ao gerar pedidos:", error);
        alert("Erro ao gerar pedidos.");
      }
    };

    function sortTable(column) {
      const tableBody = document.getElementById('quotationsTableBody');
      const rows = Array.from(tableBody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const aValue = getValueFromColumn(a, column);
        const bValue = getValueFromColumn(b, column);

        if (column === 'data') {
          return new Date(aValue) - new Date(bValue);
        } else if (column === 'valorTotal') {
          return parseFloat(aValue.replace('R$ ', '').replace(',', '.')) - parseFloat(bValue.replace('R$ ', '').replace(',', '.'));
        } else if (column === 'fornecedores') {
          return aValue.localeCompare(bValue);
        } else {
          return aValue.localeCompare(bValue);
        }
      });

      rows.forEach(row => tableBody.appendChild(row));
    }

    function getValueFromColumn(row, column) {
      const columnIndex = Array.from(row.querySelectorAll('td')).findIndex(cell => cell.closest('tr').querySelector(`th[onclick*="sortTable('${column}')"]`));
      return columnIndex !== -1 ? row.cells[columnIndex].textContent.trim() : '';
    }

    async function generateQuotationNumber() {
      try {
        const counterRef = doc(db, "contadores", "cotacoes");
        const counterDoc = await getDoc(counterRef);

        if (!counterDoc.exists()) {
          await setDoc(counterRef, { valor: 0 });
        }

        const nextNumber = (counterDoc.exists() ? counterDoc.data().valor : 0) + 1;
        await updateDoc(counterRef, { valor: nextNumber });

        const date = new Date();
        const year = date.getFullYear().toString().substr(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const sequence = nextNumber.toString().padStart(6, '0');

        const numero = `CT${year}${month}${sequence}`;
        console.log(`N√∫mero da cota√ß√£o gerado: ${numero}`);
        return numero;
      } catch (error) {
        console.error("Erro ao gerar n√∫mero da cota√ß√£o:", error);
        throw error;
      }
    }

    window.saveQuotation = async function() {
      if (!currentQuotation) return;

      try {
        // Atualizar a cota√ß√£o com os itens selecionados
        const selectedItemsData = {};
        selectedItems.forEach((fornecedorId, itemIndex) => {
          selectedItemsData[itemIndex] = fornecedorId;
        });

        await updateDoc(doc(db, "cotacoes", currentQuotation.id), {
          itensSelecionados: selectedItemsData,
          ultimaAtualizacao: Timestamp.now(),
          atualizadoPor: currentUser.nome
        });

        // Mostrar toast de sucesso
        showToast('Cota√ß√£o salva com sucesso!', 'success');

        // Recarregar dados
        await loadInitialData();
        await loadQuotations();
      } catch (error) {
        console.error("Erro ao salvar cota√ß√£o:", error);
        showToast('Erro ao salvar cota√ß√£o', 'error');
      }
    };

    window.editQuotation = async function() {
      if (!currentQuotation) return;

      // Verificar permiss√µes
      if (currentUser.nivel < 2 && !userPermissions.includes('gerenciar_cotacoes')) {
        showToast('Voc√™ n√£o tem permiss√£o para editar cota√ß√µes', 'error');
        return;
      }

      // Verificar se a cota√ß√£o pode ser editada
      if (currentQuotation.status !== 'ABERTA') {
        showToast('Apenas cota√ß√µes abertas podem ser editadas', 'error');
        return;
      }

      // Buscar produtos para o select
      const produtosSnap = await getDocs(collection(db, "produtos"));
      const produtos = produtosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Abrir modal de edi√ß√£o
      const editModal = document.createElement('div');
      editModal.className = 'modal';
      editModal.innerHTML = `
        Adding the status-rejeitada CSS class to style rejected status badges.        <div class="modal-content" style="width: 800px; max-height: 90vh; overflow-y: auto;">
          <h3>Editar Cota√ß√£o</h3>
          <div style="margin: 20px 0;">
            <label>N√∫mero da Cota√ß√£o:</label>
            <input type="text" id="editNumero" value="${currentQuotation.numero}" readonly>
          </div>

          <div style="margin: 20px 0;">
            <h4>Itens da Cota√ß√£o</h4>
            <div id="editItemsList">
              ${currentQuotation.itens.map((item, index) => `
                <div class="edit-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                  <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                      <label>Produto:</label>
                      <select class="item-select" data-index="${index}" onchange="updateItemDetails(this)">
                        ${produtos.map(produto => `
                          <option value="${produto.id}" 
                            ${produto.id === item.produtoId ? 'selected' : ''}
                            data-codigo="${produto.codigo}"
                            data-descricao="${produto.descricao}"
                            data-unidade="${produto.unidade}">
                            ${produto.codigo} - ${produto.descricao}
                          </option>
                        `).join('')}
                      </select>
                    </div>
                    <div style="flex: 1;">
                      <label>Quantidade:</label>
                      <input type="number" class="item-quantity" data-index="${index}" 
                             value="${item.quantidade}" min="1" step="1">
                    </div>
                    <div style="flex: 1;">
                      <label>Unidade:</label>
                      <input type="text" class="item-unit" data-index="${index}" 
                             value="${item.unidade}" readonly>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                      <button class="btn-danger" onclick="removeItem(${index})">Remover</button>
                    </div>
                  </div>
                  <div class="item-details" style="font-size: 0.9em; color: #666;">
                    C√≥digo: <span class="item-code">${item.codigo}</span><br>
                    Descri√ß√£o: <span class="item-description">${item.descricao}</span>
                  </div>
                </div>
              `).join('')}
            </div>
            <button class="btn-primary" onclick="addNewItem()" style="margin-top: 10px;">
              Adicionar Novo Item
            </button>
          </div>

          <div style="margin: 20px 0;">
            <label>Observa√ß√µes:</label>
            <textarea id="editObservacoes" rows="4" style="width: 100%;">${currentQuotation.observacoes || ''}</textarea>
          </div>

          <div style="margin-top: 20px;">
            <button class="btn-primary" onclick="confirmEditQuotation(this.closest('.modal'))">Salvar</button>
            <button onclick="this.closest('.modal').remove()">Cancelar</button>
          </div>
        </div>
      `;

      document.body.appendChild(editModal);
      editModal.style.display = 'block';
    };

    window.updateItemDetails = function(select) {
      const index = select.dataset.index;
      const option = select.options[select.selectedIndex];
      const itemDiv = select.closest('.edit-item');

      itemDiv.querySelector('.item-code').textContent = option.dataset.codigo;
      itemDiv.querySelector('.item-description').textContent = option.dataset.descricao;
      itemDiv.querySelector('.item-unit').value = option.dataset.unidade;
    };

    window.addNewItem = function() {
      const itemsList = document.getElementById('editItemsList');
      const produtos = Array.from(document.querySelectorAll('.item-select option')).map(opt => ({
        id: opt.value,
        codigo: opt.dataset.codigo,
        descricao: opt.dataset.descricao,
        unidade: opt.dataset.unidade
      }));

      const newIndex = itemsList.children.length;
      const newItemDiv = document.createElement('div');
      newItemDiv.className = 'edit-item';
      newItemDiv.style.cssText = 'margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;';

      newItemDiv.innerHTML = `
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <div style="flex: 1;">
            <label>Produto:</label>
            <select class="item-select" data-index="${newIndex}" onchange="updateItemDetails(this)">
              <option value="">Selecione um produto...</option>
              ${produtos.map(produto => `
                <option value="${produto.id}"
                  data-codigo="${produto.codigo}"
                  data-descricao="${produto.descricao}"
                  data-unidade="${produto.unidade}">
                  ${produto.codigo} - ${produto.descricao}
                </option>
              `).join('')}
            </select>
          </div>
          <div style="flex: 1;">
            <label>Quantidade:</label>
            <input type="number" class="item-quantity" data-index="${newIndex}" 
                   value="1" min="1" step="1">
          </div>
          <div style="flex: 1;">
            <label>Unidade:</label>
            <input type="text" class="item-unit" data-index="${newIndex}" readonly>
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button class="btn-danger" onclick="removeItem(${newIndex})">Remover</button>
          </div>
        </div>
        <div class="item-details" style="font-size: 0.9em; color: #666;">
          C√≥digo: <span class="item-code"></span><br>
          Descri√ß√£o: <span class="item-description"></span>
        </div>
      `;

      itemsList.appendChild(newItemDiv);
    };

    window.removeItem = function(index) {
      const itemDiv = document.querySelector(`.edit-item:nth-child(${index + 1})`);
      if (itemDiv) {
        itemDiv.remove();
      }
    };

    window.confirmEditQuotation = async function(dialog) {
      try {
        const observacoes = dialog.querySelector('#editObservacoes').value;
        const itemsList = dialog.querySelector('#editItemsList');
        const items = [];

        // Coletar dados dos itens
        itemsList.querySelectorAll('.edit-item').forEach(itemDiv => {
          const select = itemDiv.querySelector('.item-select');
          const quantidade = itemDiv.querySelector('.item-quantity').value;
          const unidade = itemDiv.querySelector('.item-unit').value;
          const codigo = itemDiv.querySelector('.item-code').textContent;
          const descricao = itemDiv.querySelector('.item-description').textContent;

          if (select.value) {
            items.push({
              produtoId: select.value,
              codigo: codigo,
              descricao: descricao,
              quantidade: parseInt(quantidade),
              unidade: unidade
            });
          }
        });

        if (items.length === 0) {
          showToast('Adicione pelo menos um item √† cota√ß√£o', 'error');
          return;
        }

        // Comparar itens antigos com novos para detectar altera√ß√µes
        const alteracoes = [];
        const itensAntigos = currentQuotation.itens || [];

        // Verificar itens removidos
        itensAntigos.forEach(itemAntigo => {
          if (!items.some(item => item.produtoId === itemAntigo.produtoId)) {
            alteracoes.push({
              tipo: 'remocao',
              item: itemAntigo,
              data: Timestamp.now()
            });
          }
        });

        // Verificar itens adicionados ou modificados
        items.forEach(itemNovo => {
          const itemAntigo = itensAntigos.find(item => item.produtoId === itemNovo.produtoId);

          if (!itemAntigo) {
            alteracoes.push({
              tipo: 'adicao',
              item: itemNovo,
              data: Timestamp.now()
            });
          } else if (itemAntigo.quantidade !== itemNovo.quantidade) {
            alteracoes.push({
              tipo: 'modificacao',
              itemAntigo: itemAntigo,
              itemNovo: itemNovo,
              data: Timestamp.now()
            });
          }
        });

        // Buscar dados do solicitante
        const solicitacao = solicitacoes.find(s => s.id === currentQuotation.solicitacaoId);
        const solicitanteId = solicitacao?.solicitanteId;

        // Preparar mensagem para o solicitante
        let mensagemSolicitante = `A cota√ß√£o ${currentQuotation.numero} foi atualizada:\n\n`;
        alteracoes.forEach(alteracao => {
          switch (alteracao.tipo) {
            case 'adicao':
              mensagemSolicitante += `- Novo item adicionado: ${alteracao.item.codigo} - ${alteracao.item.descricao} (${alteracao.item.quantidade} ${alteracao.item.unidade})\n`;
              break;
            case 'remocao':
              mensagemSolicitante += `- Item removido: ${alteracao.item.codigo} - ${alteracao.item.descricao}\n`;
              break;
            case 'modificacao':
              mensagemSolicitante += `- Quantidade alterada para ${alteracao.itemNovo.codigo}: ${alteracao.itemAntigo.quantidade} ‚Üí ${alteracao.itemNovo.quantidade} ${alteracao.itemNovo.unidade}\n`;
              break;
          }
        });

        // Atualizar a cota√ß√£o com as altera√ß√µes
        await updateDoc(doc(db, "cotacoes", currentQuotation.id), {
          itens: items,
          observacoes: observacoes,
          ultimaAtualizacao: Timestamp.now(),
          atualizadoPor: currentUser.nome,
          alteracoes: [...(currentQuotation.alteracoes || []), ...alteracoes]
        });

        // Se houver altera√ß√µes e um solicitante, criar notifica√ß√£o
        if (alteracoes.length > 0 && solicitanteId) {
          const notificacao = {
            tipo: 'alteracao_cotacao',
            cotacaoId: currentQuotation.id,
            cotacaoNumero: currentQuotation.numero,
            mensagem: mensagemSolicitante,
            data: Timestamp.now(),
            lida: false,
            destinatarioId: solicitanteId,
            remetenteId: currentUser.id,
            remetenteNome: currentUser.nome
          };

          await addDoc(collection(db, "notificacoes"), notificacao);
        }

        dialog.remove();
        showToast('Cota√ß√£o atualizada com sucesso!', 'success');

        // Recarregar dados
        await loadInitialData();
        await loadQuotations();
        viewQuotation(currentQuotation.id);
      } catch (error) {
        console.error("Erro ao editar cota√ß√£o:", error);
        showToast('Erro ao editar cota√ß√£o', 'error');
      }
    };

    window.deleteQuotation = async function() {
      if (!currentQuotation) return;

      // Verificar permiss√µes
      if (currentUser.nivel < 2 && !userPermissions.includes('gerenciar_cotacoes')) {
        showToast('Voc√™ n√£o tem permiss√£o para excluir cota√ß√µes', 'error');
        return;
      }

      // Verificar se a cota√ß√£o pode ser exclu√≠da
      if (currentQuotation.status !== 'ABERTA') {
        showToast('Apenas cota√ß√µes abertas podem ser exclu√≠das', 'error');
        return;
      }

      if (confirm('Tem certeza que deseja excluir esta cota√ß√£o?')) {
        try {
          await deleteDoc(doc(db, "cotacoes", currentQuotation.id));
          showToast('Cota√ß√£o exclu√≠da com sucesso!', 'success');
          closeModal('quotationModal');

          // Recarregar dados
          await loadInitialData();
          await loadQuotations();
        } catch (error) {
          console.error("Erro ao excluir cota√ß√£o:", error);
          showToast('Erro ao excluir cota√ß√£o', 'error');
        }
      }
    };

    // Adicionar fun√ß√£o para recusar cota√ß√£o
    window.rejectQuotation = async function() {
      if (!currentQuotation) return;

      // Verificar permiss√µes
      if (currentUser.nivel < 2 && !userPermissions.includes('gerenciar_cotacoes')) {
        showToast('Voc√™ n√£o tem permiss√£o para recusar cota√ß√µes', 'error');
        return;
      }

      // Verificar se a cota√ß√£o pode ser recusada
      if (currentQuotation.status === 'FECHADA' || currentQuotation.status === 'APROVADA') {
        showToast('N√£o √© poss√≠vel recusar uma cota√ß√£o j√° fechada ou aprovada', 'error');
        return;
      }

      // Criar modal de confirma√ß√£o
      const confirmModal = document.createElement('div');
      confirmModal.className = 'modal';
      confirmModal.innerHTML = `
        <div class="modal-content" style="width: 500px;">
          <h3>Recusar Cota√ß√£o</h3>
          <div style="margin: 20px 0;">
            <p><strong>N√∫mero da Cota√ß√£o:</strong> ${currentQuotation.numero}</p>
            <p><strong>Motivo da Recusa:</strong></p>
            <textarea id="rejectReason" rows="4" style="width: 100%; margin-top: 10px;" 
                      placeholder="Digite o motivo da recusa da cota√ß√£o..."></textarea>
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-danger" onclick="confirmRejectQuotation(this.closest('.modal'))">Confirmar Recusa</button>
            <button onclick="this.closest('.modal').remove()">Cancelar</button>
          </div>
        </div>
      `;

      document.body.appendChild(confirmModal);
      confirmModal.style.display = 'block';
    };

    window.confirmRejectQuotation = async function(dialog) {
      try {
        const motivo = dialog.querySelector('#rejectReason').value.trim();
        if (!motivo) {
          showToast('Por favor, informe o motivo da recusa', 'error');
          return;
        }

        // Mostrar indicador de carregamento
        const loadingToast = showToast('Processando recusa da cota√ß√£o...', 'info', true);

        // Buscar a solicita√ß√£o original
        const solicitacao = solicitacoes.find(s => s.id === currentQuotation.solicitacaoId);
        if (!solicitacao) {
          throw new Error('Solicita√ß√£o original n√£o encontrada');
        }

        // Atualizar status da cota√ß√£o
        await updateDoc(doc(db, "cotacoes", currentQuotation.id), {
          status: 'RECUSADA',
          motivoRecusa: motivo,
          dataRecusa: Timestamp.now(),
          recusadoPor: currentUser.nome
        });

        // Criar modal de op√ß√µes para o solicitante
        const optionsModal = document.createElement('div');
        optionsModal.className = 'modal';
        optionsModal.innerHTML = `
          <div class="modal-content" style="width: 600px;">
            <h3>Op√ß√µes para Nova Solicita√ß√£o</h3>
            <div style="margin: 20px 0;">
              <p>Como voc√™ deseja prosseguir com a nova solicita√ß√£o?</p>

              <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                <h4 style="color: #0854a0;">Op√ß√£o 1: Sistema MRP</h4>
                <p>Utilize o sistema MRP para gerar uma nova solicita√ß√£o automaticamente, considerando:</p>
                <ul style="margin-left: 20px;">
                  <li>Ordens de venda (demanda firme)</li>
                  <li>Previs√µes de vendas</li>
                  <li>Estoque atual</li>
                  <li>Ordens de produ√ß√£o em andamento</li>
                  <li>Compras j√° programadas</li>
                  <li>Lead time de produ√ß√£o e compra</li>
                </ul>
                <button class="btn-primary" onclick="reprocessarNecessidadesMRP('${solicitacao.id}', '${currentQuotation.id}')">
                  Reprocessar via MRP
                </button>
              </div>

              <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                <h4 style="color: #0854a0;">Op√ß√£o 2: M√©todo Manual</h4>
                <p>Crie uma nova solicita√ß√£o manualmente, permitindo:</p>
                <ul style="margin-left: 20px;">
                  <li>Definir quantidades espec√≠ficas</li>
                  <li>Escolher fornecedores alternativos</li>
                  <li>Adicionar observa√ß√µes personalizadas</li>
                  <li>Definir prioridades diferentes</li>
                </ul>
                <button class="btn-secondary" onclick="createManualRequest('${solicitacao.id}', '${currentQuotation.id}')">
                  Criar Manualmente
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(optionsModal);
        optionsModal.style.display = 'block';
        dialog.remove();

        // Registrar log da recusa
        await addDoc(collection(db, "log_cotacoes"), {
          cotacaoId: currentQuotation.id,
          cotacaoNumero: currentQuotation.numero,
          acao: 'RECUSA',
          data: Timestamp.now(),
          usuarioId: currentUser.id,
          usuarioNome: currentUser.nome,
          detalhes: {
            motivo: motivo,
            solicitacaoId: solicitacao.id,
            solicitacaoNumero: solicitacao.numero
          }
        });

        // Criar notifica√ß√£o para o solicitante
        if (solicitacao.solicitanteId) {
          const notificacao = {
            tipo: 'cotacao_recusada',
            cotacaoId: currentQuotation.id,
            cotacaoNumero: currentQuotation.numero,
            solicitacaoId: solicitacao.id,
            solicitacaoNumero: solicitacao.numero,
            mensagem: `A cota√ß√£o ${currentQuotation.numero} foi recusada. Motivo: ${motivo}\nPor favor, escolha como deseja prosseguir com a nova solicita√ß√£o.`,
            data: Timestamp.now(),
            lida: false,
            destinatarioId: solicitacao.solicitanteId,
            remetenteId: currentUser.id,
            remetenteNome: currentUser.nome,
            opcoes: ['MRP', 'MANUAL']
          };

          await addDoc(collection(db, "notificacoes"), notificacao);
        }

        loadingToast.remove();
        showToast('Cota√ß√£o recusada com sucesso!', 'success');

        // Recarregar dados e fechar modais
        await loadInitialData();
        await loadQuotations();
        closeModal('quotationModal');
      } catch (error) {
        console.error("Erro ao recusar cota√ß√£o:", error);
        showToast(`Erro ao recusar cota√ß√£o: ${error.message}`, 'error');
      }
    };

    // Fun√ß√£o para criar solicita√ß√£o via MRP
    window.createMRPRequest = async function(solicitacaoId, cotacaoId) {
      try {
        const loadingToast = showToast('Criando nova solicita√ß√£o via MRP...', 'info', true);

        // Buscar dados da solicita√ß√£o original
        const solicitacaoOriginal = solicitacoes.find(s => s.id === solicitacaoId);
        if (!solicitacaoOriginal) {
          throw new Error('Solicita√ß√£o original n√£o encontrada');
        }

        // Buscar dados do MRP
        const mrpSnap = await getDocs(collection(db, "mrp"));
        const mrpData = mrpSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Calcular nova demanda baseada no MRP
        const novaDemanda = await calcularDemandaMRP(solicitacaoOriginal.itens, mrpData);

        // Criar nova solicita√ß√£o
        const novaSolicitacao = {
          numero: await gerarNumeroSolicitacao(),
          tipo: 'MRP',
          solicitanteId: solicitacaoOriginal.solicitanteId,
          solicitanteNome: solicitacaoOriginal.solicitanteNome,
          departamento: solicitacaoOriginal.departamento,
          dataCriacao: Timestamp.now(),
          status: 'PENDENTE',
          itens: novaDemanda,
          observacoes: `Solicita√ß√£o gerada via MRP ap√≥s recusa da cota√ß√£o ${currentQuotation.numero}`,
          cotacaoRecusadaId: cotacaoId,
          origem: 'MRP'
        };

        // Salvar nova solicita√ß√£o
        const novaSolicitacaoRef = await addDoc(collection(db, "solicitacoesCompra"), novaSolicitacao);

        // Registrar log
        await addDoc(collection(db, "log_solicitacoes"), {
          solicitacaoId: novaSolicitacaoRef.id,
          solicitacaoNumero: novaSolicitacao.numero,
          acao: 'CRIACAO_MRP',
          data: Timestamp.now(),
          usuarioId: currentUser.id,
          usuarioNome: currentUser.nome,
          detalhes: {
            cotacaoRecusadaId: cotacaoId,
            itens: novaDemanda
          }
        });

        loadingToast.remove();
        showToast('Nova solicita√ß√£o criada via MRP com sucesso!', 'success');

        // Redirecionar para a nova solicita√ß√£o
        window.location.href = `solicitacoes.html?id=${novaSolicitacaoRef.id}`;
      } catch (error) {
        console.error("Erro ao criar solicita√ß√£o via MRP:", error);
        showToast('Erro ao criar solicita√ß√£o via MRP', 'error');
      }
    };

    // Fun√ß√£o para criar solicita√ß√£o manual
    window.createManualRequest = async function(solicitacaoId, cotacaoId) {
      try {
        // Buscar dados da solicita√ß√£o original
        const solicitacaoOriginal = solicitacoes.find(s => s.id === solicitacaoId);
        if (!solicitacaoOriginal) {
          throw new Error('Solicita√ß√£o original n√£o encontrada');
        }

        // Validar dados do solicitante
        if (!solicitacaoOriginal.solicitanteId || !solicitacaoOriginal.solicitanteNome) {
          throw new Error('Dados do solicitante n√£o encontrados na solicita√ß√£o original');
        }

        // Validar itens
        if (!solicitacaoOriginal.itens || solicitacaoOriginal.itens.length === 0) {
          throw new Error('A solicita√ß√£o original n√£o possui itens');
        }

        // Criar nova solicita√ß√£o baseada na original
        const novaSolicitacao = {
          numero: await gerarNumeroSolicitacao(),
          tipo: 'MANUAL',
          solicitanteId: solicitacaoOriginal.solicitanteId,
          solicitanteNome: solicitacaoOriginal.solicitanteNome,
          departamento: solicitacaoOriginal.departamento || 'N√£o especificado',
          dataCriacao: Timestamp.now(),
          status: 'PENDENTE',
          itens: solicitacaoOriginal.itens.map(item => ({
            produtoId: item.produtoId,
            codigo: item.codigo,
            descricao: item.descricao,
            quantidade: item.quantidade,
            unidade: item.unidade,
            quantidadeOriginal: item.quantidade,
            motivoAjuste: 'MANUAL'
          })),
          observacoes: `Solicita√ß√£o manual ap√≥s recusa da cota√ß√£o ${currentQuotation.numero}`,
          cotacaoRecusadaId: cotacaoId,
          origem: 'MANUAL',
          prioridade: solicitacaoOriginal.prioridade || 'NORMAL',
          centroCusto: solicitacaoOriginal.centroCusto || null,
          dataNecessidade: solicitacaoOriginal.dataNecessidade || null
        };

        // Validar dados antes de salvar
        if (!novaSolicitacao.solicitanteId || !novaSolicitacao.solicitanteNome) {
          throw new Error('Dados do solicitante s√£o obrigat√≥rios');
        }

        if (!novaSolicitacao.itens || novaSolicitacao.itens.length === 0) {
          throw new Error('A solicita√ß√£o deve conter pelo menos um item');
        }

        // Salvar nova solicita√ß√£o
        const novaSolicitacaoRef = await addDoc(collection(db, "solicitacoesCompra"), novaSolicitacao);

        // Registrar log
        await addDoc(collection(db, "log_solicitacoes"), {
          solicitacaoId: novaSolicitacaoRef.id,
          solicitacaoNumero: novaSolicitacao.numero,
          acao: 'CRIACAO_MANUAL',
          data: Timestamp.now(),
          usuarioId: currentUser.id,
          usuarioNome: currentUser.nome,
          detalhes: {
            cotacaoRecusadaId: cotacaoId,
            itens: novaSolicitacao.itens,
            solicitanteId: novaSolicitacao.solicitanteId,
            solicitanteNome: novaSolicitacao.solicitanteNome
          }
        });

        showToast('Nova solicita√ß√£o criada manualmente com sucesso!', 'success');

        // Redirecionar para a nova solicita√ß√£o
        window.location.href = `solicitacoes.html?id=${novaSolicitacaoRef.id}`;
      } catch (error) {
        console.error("Erro ao criar solicita√ß√£o manual:", error);
        showToast(`Erro ao criar solicita√ß√£o manual: ${error.message}`, 'error');
      }
    };

    // Fun√ß√£o auxiliar para calcular demanda via MRP
    async function calcularDemandaMRP(itens, mrpData) {
      const novaDemanda = [];

      for (const item of itens) {
        try {
          // Buscar dados do item no MRP
          const mrpItem = mrpData.find(m => m.produtoId === item.produtoId);

          if (mrpItem) {
            // Dados de demanda
            const demandaFirme = mrpItem.ordensVenda?.reduce((sum, ordem) => sum + ordem.quantidade, 0) || 0;
            const previsaoVendas = mrpItem.previsaoVendas || 0;
            const demandaTotal = demandaFirme + previsaoVendas;

            // Dados de disponibilidade
            const estoqueAtual = mrpItem.estoqueAtual || 0;
            const pedidosEmAndamento = mrpItem.pedidosEmAndamento?.reduce((sum, pedido) => sum + pedido.quantidade, 0) || 0;
            const ordensProducao = mrpItem.ordensProducao?.reduce((sum, op) => sum + op.quantidade, 0) || 0;
            const disponibilidadeTotal = estoqueAtual + pedidosEmAndamento + ordensProducao;

            // Dados de lead time
            const leadTimeCompra = mrpItem.leadTimeCompra || 0;
            const leadTimeProducao = mrpItem.leadTimeProducao || 0;
            const leadTimeTotal = Math.max(leadTimeCompra, leadTimeProducao);

            // C√°lculo da necessidade l√≠quida
            const necessidadeLiquida = Math.max(0, demandaTotal - disponibilidadeTotal);

            // Ajuste baseado no lead time
            const necessidadeAjustada = necessidadeLiquida * (1 + (leadTimeTotal / 30)); // Ajuste mensal

            // Adicionar √† nova demanda
            novaDemanda.push({
              ...item,
              quantidade: Math.ceil(necessidadeAjustada), // Arredonda para cima
              quantidadeOriginal: item.quantidade,
              motivoAjuste: 'MRP',
              detalhesMRP: {
                demandaFirme,
                previsaoVendas,
                estoqueAtual,
                pedidosEmAndamento,
                ordensProducao,
                leadTimeTotal,
                necessidadeLiquida,
                necessidadeAjustada
              }
            });
          } else {
            // Se n√£o encontrar no MRP, mant√©m a quantidade original
            novaDemanda.push({
              ...item,
              quantidadeOriginal: item.quantidade,
              motivoAjuste: 'SEM_DADOS_MRP',
              detalhesMRP: {
                mensagem: 'Item n√£o encontrado no MRP'
              }
            });
          }
        } catch (error) {
          console.error(`Erro ao calcular demanda MRP para item ${item.codigo}:`, error);
          novaDemanda.push({
            ...item,
            quantidadeOriginal: item.quantidade,
            motivoAjuste: 'ERRO_CALCULO',
            detalhesMRP: {
              erro: error.message
            }
          });
        }
      }

      return novaDemanda;
    }

    // Fun√ß√£o auxiliar para gerar n√∫mero de solicita√ß√£o
    async function gerarNumeroSolicitacao() {
      try {
        const counterRef = doc(db, "contadores", "solicitacoes");
        const counterDoc = await getDoc(counterRef);

        if (!counterDoc.exists()) {
          await setDoc(counterRef, { valor: 0 });
        }

        const nextNumber = (counterDoc.exists() ? counterDoc.data().valor : 0) + 1;
        await updateDoc(counterRef, { valor: nextNumber });

        const date = new Date();
        const year = date.getFullYear().toString().substr(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const sequence = nextNumber.toString().padStart(6, '0');

        return `SC${year}${month}${sequence}`;
      } catch (error) {
        console.error("Erro ao gerar n√∫mero da solicita√ß√£o:", error);
        throw error;
      }
    }

    // Fun√ß√£o auxiliar para mostrar toasts com op√ß√£o de loading
    function showToast(message, type = 'success', isLoading = false) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: fadeInOut 2s ease-in-out;
        display: flex;
        align-items: center;
        gap: 10px;
      `;

      if (isLoading) {
        toast.innerHTML = `
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="sr-only">Carregando...</span>
          </div>
          ${message}
        `;
      } else {
        toast.textContent = message;
      }

      document.body.appendChild(toast);

      if (!isLoading) {
        setTimeout(() => {
          toast.remove();
        }, 2000);
      }

      return toast;
    }

    // Fun√ß√£o para reprocessar necessidades ap√≥s cancelamento
    async function reprocessarNecessidadesMRP(solicitacaoId, cotacaoId) {
      try {
        // Buscar dados da solicita√ß√£o original
        const solicitacaoOriginal = solicitacoes.find(s => s.id === solicitacaoId);
        if (!solicitacaoOriginal) {
          throw new Error('Solicita√ß√£o original n√£o encontrada');
        }

        // Buscar dados do MRP atualizados
        const mrpSnap = await getDocs(collection(db, "mrp"));
        const mrpData = mrpSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Calcular nova demanda
        const novaDemanda = await calcularDemandaMRP(solicitacaoOriginal.itens, mrpData);

        // Criar nova solicita√ß√£o com as necessidades recalculadas
        const novaSolicitacao = {
          numero: await gerarNumeroSolicitacao(),
          tipo: 'MRP_REPROCESSADO',
          solicitanteId: solicitacaoOriginal.solicitanteId,
          solicitanteNome: solicitacaoOriginal.solicitanteNome,
          departamento: solicitacaoOriginal.departamento || 'N√£o especificado',
          dataCriacao: Timestamp.now(),
          status: 'PENDENTE',
          itens: novaDemanda,
          observacoes: `Solicita√ß√£o reprocessada via MRP ap√≥s cancelamento da cota√ß√£o ${currentQuotation.numero}`,
          cotacaoRecusadaId: cotacaoId,
          origem: 'MRP_REPROCESSADO',
          prioridade: solicitacaoOriginal.prioridade || 'NORMAL',
          centroCusto: solicitacaoOriginal.centroCusto || null,
          dataNecessidade: solicitacaoOriginal.dataNecessidade || null
        };

        // Salvar nova solicita√ß√£o
        const novaSolicitacaoRef = await addDoc(collection(db, "solicitacoesCompra"), novaSolicitacao);

        // Registrar log do reprocessamento
        await addDoc(collection(db, "log_solicitacoes"), {
          solicitacaoId: novaSolicitacaoRef.id,
          solicitacaoNumero: novaSolicitacao.numero,
          acao: 'REPROCESSAMENTO_MRP',
          data: Timestamp.now(),
          usuarioId: currentUser.id,
          usuarioNome: currentUser.nome,
          detalhes: {
            cotacaoRecusadaId: cotacaoId,
            solicitacaoOriginalId: solicitacaoId,
            itens: novaDemanda
          }
        });

        return novaSolicitacaoRef.id;
      } catch (error) {
        console.error("Erro ao reprocessar necessidades MRP:", error);
        throw error;
      }
    }
  </script>
</body>
</html>